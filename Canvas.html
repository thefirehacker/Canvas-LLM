<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Content Security Policy - Fallback for local development and non-Amplify deployments -->
  <!-- Note: Amplify server headers take precedence when deployed -->
  <meta http-equiv="Content-Security-Policy" content="
    script-src 'self' 'unsafe-eval' 'unsafe-inline' https: data: blob:;
    style-src 'self' 'unsafe-inline' https: data:;
    connect-src 'self' https: wss: https://beluga.bubblspace.com http://localhost:1234 http://localhost:11434;
    img-src 'self' data: https: blob:;
    font-src 'self' data: https:;
    worker-src 'self' blob: data:;
    object-src 'none';
  ">
  <title>Playground - TimeCapsule-SLM</title>
  <link rel="icon" type="image/png" href="lib/Media/TimeCapsule_04.png">
  <link rel="shortcut icon" type="image/png" href="lib/Media/TimeCapsule_04.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; 
      overflow: hidden;
      padding-top: 120px;
    }
    
    .container {
      display: grid;
      grid-template-columns: 250px 1fr 6px 2fr;
      grid-template-rows: 140px 1fr;
      height: calc(100vh - 120px);
      gap: 10px;
      padding: 10px;
      position: relative;
    }
    
    .header {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      background: linear-gradient(45deg, #fff, #f0f8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .controls-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      overflow-y: auto;
    }
    
    .controls-panel h3 {
      margin-bottom: 20px;
      font-size: 18px;
      color: #fff;
      text-align: center;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .btn {
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.primary {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .btn.primary:hover {
      box-shadow: 0 8px 25px rgba(250, 112, 154, 0.6);
    }
    
    .btn.secondary {
      background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
      box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);
    }
    
    select, input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    select option {
      background: #333;
      color: white;
    }
    
    .editor-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .editor-container.expanded {
      grid-column: 2 / -1;
      z-index: 100;
    }
    
    .editor-container.minimized {
      height: 60px;
      overflow: hidden;
    }
    
    .editor-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .editor-controls {
      display: flex;
      gap: 8px;
    }
    
    .editor-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .editor-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }
    
    #editor { 
      flex: 1;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .canvas-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .canvas-container.hidden {
      display: none;
    }

    /* Resize Handle */
    .resize-handle {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      cursor: col-resize;
      position: relative;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    
    .resize-handle:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: scaleX(1.2);
    }
    
    .resize-handle:active {
      background: rgba(79, 172, 254, 0.6);
      transform: scaleX(1.5);
    }
    
    .resize-handle::after {
      content: '';
      width: 2px;
      height: 40px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 1px;
    }
    
    .resize-handle:hover::after {
      background: rgba(255, 255, 255, 0.8);
      height: 60px;
    }
    
    .resize-handle.dragging {
      background: rgba(79, 172, 254, 0.8);
      transform: scaleX(2);
    }
    
    .resize-handle.dragging::after {
      background: rgba(255, 255, 255, 1);
      height: 80px;
    }
    
    .canvas-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .canvas-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .canvas-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .canvas-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }
    
    .canvas-btn.active {
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      border-color: rgba(79, 172, 254, 0.5);
    }
    
    .speed-btn {
      min-width: 50px;
      font-size: 11px;
    }
    
    .speed-btn.slow {
      background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%);
    }
    
    .speed-btn.fast {
      background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
    }
    
    .speed-btn.very-fast {
      background: linear-gradient(45deg, #ffecd2 0%, #fcb69f 100%);
    }
    
    #canvas { 
      flex: 1;
      background: #111; 
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .status-bar {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .hidden {
      display: none;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Logo hover effect */
    .header img:hover {
      transform: scale(1.05) rotate(2deg);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5)) brightness(1.2);
      border-color: rgba(255,255,255,0.5);
    }
    
    /* Floating AI Panel (Cursor-style) */
    .ai-floating-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .ai-floating-panel.minimized {
      height: auto; /* Let header determine height */
      min-height: 60px;
      width: 300px;
      overflow: hidden; /* Hide content that goes beyond minimized state */
    }
    
    .ai-floating-panel.minimized .ai-panel-header {
      border-bottom: none; /* Remove bottom border when minimized */
      border-radius: 15px; /* Match panel border radius */
    }
    
    .ai-floating-panel.hidden {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    /* AI Toggle Button (always visible) */
    .ai-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
      transition: all 0.3s ease;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
    }
    
    .ai-toggle-btn.active {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 20px rgba(250, 112, 154, 0.4);
    }
    
    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      color: white;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ai-panel-controls {
      display: flex;
      gap: 8px;
    }
    
    .panel-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .panel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .ai-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
    }
    
    .ai-content.minimized {
      display: none;
    }
    
    .ai-floating-panel.minimized .ai-panel-header {
      display: flex; /* Keep header visible when minimized */
      cursor: pointer; /* Make it clear you can click to restore */
    }
    
    .ai-floating-panel.minimized .ai-panel-header:hover {
      background: rgba(255, 255, 255, 0.1); /* Hover effect when minimized */
    }
    
    .chat-history {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      min-height: 150px;
    }
    
    .ai-input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .ai-prompt-input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }
    
    .ai-prompt-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-actions {
      display: flex;
      gap: 8px;
    }
    
    .ai-btn {
      flex: 1;
      padding: 10px 16px;
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .ai-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-btn.secondary {
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .chat-message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .chat-message.user {
      background: rgba(79, 172, 254, 0.2);
      color: #e6f3ff;
      margin-left: 20px;
    }
    
    .chat-message.ai {
      background: rgba(250, 112, 154, 0.2);
      color: #ffe6f0;
      margin-right: 20px;
    }
    
    .chat-message.system {
      background: rgba(168, 237, 234, 0.2);
      color: #e6fffe;
      font-style: italic;
      text-align: center;
    }
    
    .message-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .code-preview {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 8px;
      border-left: 3px solid #4facfe;
    }
    
    /* Dev Mode Logger */
    .dev-logger-window {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 600px;
      height: 500px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.1);
      z-index: 1500;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      resize: both;
      overflow: hidden;
      min-width: 400px;
      min-height: 300px;
      max-width: 90vw;
      max-height: 90vh;
    }
    
    .dev-logger-window.minimized {
      display: none;
    }
    
    .dev-logger-window.hidden {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .dev-logger-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: grab;
      user-select: none;
    }
    
    .dev-logger-header:active {
      cursor: grabbing;
    }
    
    .dev-logger-title {
      color: white;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .dev-logger-controls {
      display: flex;
      gap: 8px;
    }
    
    .dev-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    
    .dev-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    
    .dev-logger-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .dev-logger-content.minimized {
      display: none;
    }
    
    .dev-logger-tabs {
      display: flex;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .dev-tab {
      padding: 10px 15px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
    }
    
    .dev-tab.active {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border-bottom-color: #4facfe;
    }
    
    .dev-tab:hover {
      color: white;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .dev-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .dev-log-entry {
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 4px solid #4facfe;
    }
    
    .dev-log-entry.error {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
    
    .dev-log-entry.warning {
      border-left-color: #ff9800;
      background: rgba(255, 152, 0, 0.1);
    }
    
    .dev-log-entry.success {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    .dev-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .dev-log-timestamp {
      color: rgba(255, 255, 255, 0.6);
      font-size: 10px;
    }
    
    .dev-log-stage {
      color: #4facfe;
      font-weight: bold;
      font-size: 11px;
    }
    
    .dev-log-message {
      color: white;
      margin-bottom: 8px;
    }
    
    .dev-log-data {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 5px;
      color: #e0e0e0;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .dev-log-expand {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #4facfe;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      margin-top: 5px;
    }
    
    .dev-log-expand:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .dev-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .dev-stat {
      text-align: center;
    }
    
    .dev-stat-value {
      color: #4facfe;
      font-weight: bold;
      font-size: 16px;
    }
    
    .dev-stat-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 10px;
      text-transform: uppercase;
    }

    /* Context Editor Modal */
    .context-editor-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .context-editor-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      color: white;
    }
    
    .context-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .context-editor-header h2 {
      margin: 0;
      font-size: 22px;
    }
    
    .model-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .model-selector select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }
    
    .context-sections {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .context-section {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .context-section h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #fff;
    }
    
    .context-input-group {
      margin-bottom: 15px;
    }
    
    .context-input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
    }
    
    .context-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      padding: 10px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      min-height: 80px;
    }
    
    .context-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .context-textarea.large {
      min-height: 120px;
    }
    
    .context-editor-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    .context-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .context-btn.primary {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      color: white;
    }
    
    .context-btn.secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .context-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .context-template-hint {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
      font-style: italic;
    }
    

    
    /* TimeCapsule Glow Animation */
    @keyframes capsuleGlow {
      0%, 100% { 
        opacity: 0.6;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.1);
      }
    }
    

  </style>
</head>
<body>
  <!-- BubblSpace Navigation Component -->
  <div id="bubblspace-navbar"></div>
  <script src="lib/Pages/components/bubblspace-navbar.js"></script>
  
  <!-- Second Navbar Component -->
  <script src="lib/Pages/components/second-navbar.js"></script>

  <div class="container">
    <div class="controls-panel">
      <h3>🎮 Controls</h3>
      
      <div class="control-group">
        <button id="runBtn" class="btn primary">▶️ Draw</button>
      </div>
      
      <div class="control-group">
        <label>📁 Load Design:</label>
        <select id="designSelect">
          <option value="">Choose a design...</option>
          <option value="fish">🐟 Fish Animation</option>
          <option value="bird">🦅 Bird Flight</option>
          <option value="rabbit">🐰 Rabbit Bounce</option>
          <option value="spiral">🌀 Rainbow Spiral</option>
          <option value="cosmic-spiral">🌊 Dancing Sine Wave</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>📂 File Operations:</label>
        <input type="file" id="fileInput" accept=".js" class="hidden">
        <button id="loadFileBtn" class="btn secondary">📁 Load JS File</button>
        <button id="saveFileBtn" class="btn secondary">💾 Save JS File</button>
      </div>
      

      
      <div class="control-group">
        <label>🎯 Quick Actions:</label>
        <button id="clearBtn" class="btn">🗑️ Clear Canvas</button>
        <button id="resetBtn" class="btn">🔄 Reset Code</button>
      </div>
      
      <div class="status-bar" id="statusBar">
        Ready to create amazing p5.js art! 🚀
      </div>
      
      <!-- Usage Agreement & Terms Section -->
      <div class="control-group" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
        <button id="agreementStatusBtn" class="btn secondary" style="padding: 8px 12px; font-size: 12px; cursor: pointer;">
          📋 Usage Agreement & Terms
        </button>
        <div id="agreementStatus" style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 5px; text-align: center;">
          Status: Not Reviewed
        </div>
      </div>
      
      <!-- Creator Attribution -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">
          Created by
        </div>
        <a href="https://x.com/thefirehacker" target="_blank" style="
          color: rgba(255,255,255,0.8); 
          text-decoration: none; 
          font-size: 12px; 
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 4px 8px;
          border-radius: 6px;
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.1);
          transition: all 0.3s ease;
        " 
        onmouseover="
          this.style.background='rgba(255,255,255,0.1)'; 
          this.style.borderColor='rgba(255,255,255,0.2)';
          this.style.color='white';
          this.style.transform='translateY(-1px)';
        " 
        onmouseout="
          this.style.background='rgba(255,255,255,0.05)'; 
          this.style.borderColor='rgba(255,255,255,0.1)';
          this.style.color='rgba(255,255,255,0.8)';
          this.style.transform='translateY(0)';
        ">
          🧙‍♂️ FireHacker
        </a>
      </div>
      
      <!-- API Key Section (hidden by default) -->
      <div class="control-group" id="apiKeySection" style="display: none; margin-top: 15px;">
        <label>🔑 OpenAI API Configuration:</label>
        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
          <input type="text" id="openaiApiKey" placeholder="OpenAI_API_KEY" 
                 style="flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                        border-radius: 6px; color: white; font-size: 12px;" type="password">
          <button id="toggleApiKeyVisibility" class="editor-btn" title="Toggle API Key Visibility" 
                  style="min-width: 35px; padding: 6px;">👁️</button>
        </div>
        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">
          API key is stored for this session only. Not saved permanently.
        </div>
      </div>
    </div>
    
    <div class="editor-container" id="editorContainer">
      <div class="editor-header">
        <span>📝 Code Editor</span>
        <div class="editor-controls">
          <button class="editor-btn" id="copyCodeBtn" title="Copy Code">📄</button>
          <button class="editor-btn" id="minimizeEditorBtn" title="Minimize Editor">−</button>
          <button class="editor-btn" id="expandEditorBtn" title="Expand Editor">⤢</button>
        </div>
      </div>
      <div id="editor"></div>
    </div>
    
    <div class="resize-handle" id="resizeHandle" title="Drag to resize editor and canvas | Double-click to reset to default"></div>
    
    <div class="canvas-container">
      <div class="canvas-header">
        <span>🖼️ Canvas Output</span>
        <div class="canvas-controls">
          <button class="canvas-btn" id="pausePlayBtn" title="Pause/Play Animation">⏸️</button>
          <button class="canvas-btn speed-btn slow" id="speedBtn" title="Animation Speed">SLOW</button>
        </div>
      </div>
      <div id="canvas"></div>
    </div>
  </div>

  <!-- Floating AI Toggle Button -->
  <button class="ai-toggle-btn" id="aiToggleBtn">🤖</button>

  <!-- Dev Mode Logger Window -->
  <div class="dev-logger-window hidden" id="devLoggerWindow">
    <div class="dev-logger-header" id="devLoggerHeader">
      <div class="dev-logger-title">
        <span>🔧</span>
        <span>Dev Mode Logger</span>
        <span id="devModeStatus" style="font-size: 10px; color: rgba(255,255,255,0.6);">INACTIVE</span>
      </div>
      <div class="dev-logger-controls">
        <button class="dev-btn" id="devClearBtn" title="Clear Logs">🗑️</button>
        <button class="dev-btn" id="devMinimizeBtn" title="Minimize">−</button>
        <button class="dev-btn" id="devCloseBtn" title="Close">×</button>
      </div>
    </div>
    
    <div class="dev-logger-content" id="devLoggerContent">
      <div class="dev-logger-tabs">
        <button class="dev-tab active" data-tab="pipeline">🎯 Pipeline</button>
        <button class="dev-tab" data-tab="requests">🚀 API Calls</button>
        <button class="dev-tab" data-tab="responses">📥 Responses</button>
        <button class="dev-tab" data-tab="stats">📊 Stats</button>
      </div>
      
      <div class="dev-tab-content" id="devTabPipeline">
        <div class="dev-stats">
          <div class="dev-stat">
            <div class="dev-stat-value" id="devStatPipelines">0</div>
            <div class="dev-stat-label">Pipelines</div>
          </div>
          <div class="dev-stat">
            <div class="dev-stat-value" id="devStatApiCalls">0</div>
            <div class="dev-stat-label">API Calls</div>
          </div>
          <div class="dev-stat">
            <div class="dev-stat-value" id="devStatSuccess">0</div>
            <div class="dev-stat-label">Success</div>
          </div>
          <div class="dev-stat">
            <div class="dev-stat-value" id="devStatErrors">0</div>
            <div class="dev-stat-label">Errors</div>
          </div>
        </div>
        <div id="devPipelineLogs"></div>
      </div>
      
      <div class="dev-tab-content" id="devTabRequests" style="display: none;">
        <div id="devRequestLogs"></div>
      </div>
      
      <div class="dev-tab-content" id="devTabResponses" style="display: none;">
        <div id="devResponseLogs"></div>
      </div>
      
      <div class="dev-tab-content" id="devTabStats" style="display: none;">
        <div id="devStatsContent">
          <div style="color: rgba(255,255,255,0.8); text-align: center; padding: 20px;">
            📊 Detailed statistics will appear here during dev mode sessions
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating AI Panel -->
  <div class="ai-floating-panel hidden" id="aiFloatingPanel">
    <div class="ai-panel-header">
      <span>🤖 AI Assistant</span>
      <div class="ai-panel-controls">
        <button class="panel-btn" id="minimizeBtn">−</button>
        <button class="panel-btn" id="closeBtn">×</button>
      </div>
    </div>
    
    <div class="ai-content" id="aiContent">
      <div class="ai-status-bar">
        <div id="aiStatus">AI: Not connected</div>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <button id="chatModeBtn" class="panel-btn">🎨 Creative Mode</button>
          <button id="contextBtn" class="panel-btn">⚙️ Context</button>
          <button id="devModeBtn" class="panel-btn">🔧 Dev Mode</button>
          <button id="devLoggerToggle" class="panel-btn" style="display: none; background: rgba(255,152,0,0.3); border-color: rgba(255,152,0,0.5);">📊 Logger</button>
          <select id="aiProviderSelect" style="padding: 4px 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; color: white; font-size: 11px;">
            <option value="ollama" style="background: #2a2a2a; color: white;">🦙 Ollama</option>
            <option value="lmstudio" style="background: #2a2a2a; color: white;">🏠 LM Studio</option>
            <option value="openai" style="background: #2a2a2a; color: white;">🤖 OpenAI API</option>
            <option value="local" style="background: #2a2a2a; color: white;">🧠 Local Qwen</option>
          </select>
          <button id="initAIBtn" class="panel-btn">🦙 Connect Ollama</button>
          <button id="disconnectAIBtn" class="panel-btn" style="display: none; background: rgba(255,69,0,0.3); border-color: rgba(255,69,0,0.5);">🔌 Disconnect</button>
        </div>
      </div>
      
      <div class="chat-history" id="chatHistory">
        <div class="chat-message system">
          <div class="message-header">⚙️ System</div>
          Welcome to AI-powered creative coding! Connect AI and start chatting to generate amazing p5.js art.
        </div>
      </div>
      
      <div class="ai-input-section">
        <textarea 
          id="aiPrompt" 
          class="ai-prompt-input"
          placeholder="Describe what you want to create... e.g., 'colorful spinning triangles' or 'particle system with gravity'"
        ></textarea>
        <div class="ai-actions">
          <button id="generateBtn" class="ai-btn" disabled>✨ Generate Code</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration and Analytics -->
  <script src="config.js"></script>
  
  <!-- AI Agent System -->
  <script src="lib/agent/canvas.js"></script>

  <!-- Dependencies -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs/loader.js"></script>
  
  <!-- Load User Agreement Module -->
  <script src="lib/useragreement/agreement.js"></script>

  <script>
    // Initialize Google Analytics and Agreement Status
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the modular agreement system
      if (window.userAgreement) {
        window.userAgreement.initializeForPage();
      }
      
      if (window.AppConfig) {
        window.AppConfig.initializeGA4();
        
        // Track initial page view
        window.AppConfig.trackPageView('Playground - TimeCapsule-SLM', window.location.href);
      }
      
      // Set initial status message for Ollama default
      setTimeout(() => {
        if (typeof updateStatus === 'function') {
          updateStatus('🦙 Ollama mode enabled. Make sure Ollama is running on port 11434.');
        }
      }, 500);
    });

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs' } });

    let editorInstance, currentP5, aiSession = null;
    let chatHistory = [];
    let chatMode = 'creative'; // 'creative' or 'general'
    let aiProvider = 'ollama'; // 'ollama' = Ollama, 'lmstudio' = LM Studio, 'openai' = OpenAI API, 'local' = Local Qwen
    let openaiApiKey = ''; // Session API key
    
    // Canvas animation controls
    let animationPaused = false;
    let animationSpeed = 'slow'; // 'slow', 'fast', 'very-fast'
    let speedMultiplier = 0.5; // Default slow speed

    let pendingAIInitialization = false; // Track if user explicitly wants to initialize AI
    
    // Initialize AI Agent System
    let canvaCore = null;
    
    // Dev Mode Logger System
    let devModeActive = false;
    let devLogger = null;
    
    // Dev Logger Class
    class DevLogger {
      constructor() {
        this.logs = {
          pipeline: [],
          requests: [],
          responses: [],
          stats: {
            pipelines: 0,
            apiCalls: 0,
            success: 0,
            errors: 0,
            startTime: Date.now()
          }
        };
        this.isVisible = false;
        this.isMinimized = false;
        this.currentTab = 'pipeline';
        this.setupEventListeners();
        this.makeDraggable();
      }
      
      show() {
        const window = document.getElementById('devLoggerWindow');
        window.classList.remove('hidden');
        this.isVisible = true;
        document.getElementById('devModeStatus').textContent = 'ACTIVE';
        document.getElementById('devModeStatus').style.color = '#4CAF50';
      }
      
      hide() {
        const window = document.getElementById('devLoggerWindow');
        window.classList.add('hidden');
        this.isVisible = false;
        document.getElementById('devModeStatus').textContent = 'INACTIVE';
        document.getElementById('devModeStatus').style.color = 'rgba(255,255,255,0.6)';
      }
      
      minimize() {
        const window = document.getElementById('devLoggerWindow');
        const btn = document.getElementById('devMinimizeBtn');
        
        if (this.isMinimized) {
          window.classList.remove('minimized');
          btn.textContent = '−';
          this.isMinimized = false;
          this.isVisible = true;
          document.getElementById('devModeStatus').textContent = 'ACTIVE';
          document.getElementById('devModeStatus').style.color = '#4CAF50';
        } else {
          window.classList.add('minimized');
          btn.textContent = '+';
          this.isMinimized = true;
          this.isVisible = false;
          document.getElementById('devModeStatus').textContent = 'MINIMIZED';
          document.getElementById('devModeStatus').style.color = '#ff9800';
        }
      }
      
      clear() {
        this.logs.pipeline = [];
        this.logs.requests = [];
        this.logs.responses = [];
        this.logs.stats = {
          pipelines: 0,
          apiCalls: 0,
          success: 0,
          errors: 0,
          startTime: Date.now()
        };
        this.updateDisplay();
      }
      
      logPipeline(stage, message, data = null, level = 'info') {
        const entry = {
          timestamp: Date.now(),
          stage: stage,
          message: message,
          data: data,
          level: level,
          id: Date.now() + Math.random()
        };
        
        this.logs.pipeline.push(entry);
        
        if (level === 'error') this.logs.stats.errors++;
        if (level === 'success') this.logs.stats.success++;
        
        this.updateDisplay();
      }
      
      logRequest(url, method, headers, body, stage) {
        const entry = {
          timestamp: Date.now(),
          url: url,
          method: method,
          headers: headers,
          body: body,
          stage: stage,
          id: Date.now() + Math.random()
        };
        
        this.logs.requests.push(entry);
        this.logs.stats.apiCalls++;
        this.updateDisplay();
      }
      
      logResponse(requestId, status, headers, body, stage) {
        const entry = {
          timestamp: Date.now(),
          requestId: requestId,
          status: status,
          headers: headers,
          body: body,
          stage: stage,
          id: Date.now() + Math.random()
        };
        
        this.logs.responses.push(entry);
        this.updateDisplay();
      }
      
      startPipeline(userPrompt) {
        this.logs.stats.pipelines++;
        this.logPipeline('INIT', `Starting pipeline for: "${userPrompt}"`, { userPrompt }, 'info');
      }
      
      updateDisplay() {
        this.updateStats();
        this.updateCurrentTab();
      }
      
      updateStats() {
        document.getElementById('devStatPipelines').textContent = this.logs.stats.pipelines;
        document.getElementById('devStatApiCalls').textContent = this.logs.stats.apiCalls;
        document.getElementById('devStatSuccess').textContent = this.logs.stats.success;
        document.getElementById('devStatErrors').textContent = this.logs.stats.errors;
      }
      
      updateCurrentTab() {
        if (this.currentTab === 'pipeline') {
          this.renderPipelineLogs();
        } else if (this.currentTab === 'requests') {
          this.renderRequestLogs();
        } else if (this.currentTab === 'responses') {
          this.renderResponseLogs();
        } else if (this.currentTab === 'stats') {
          this.renderStatsTab();
        }
      }
      
      renderPipelineLogs() {
        const container = document.getElementById('devPipelineLogs');
        const logs = this.logs.pipeline.slice(-20); // Show last 20 entries
        
        container.innerHTML = logs.map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          const dataPreview = log.data ? JSON.stringify(log.data).substring(0, 100) + '...' : '';
          
          return `
            <div class="dev-log-entry ${log.level}">
              <div class="dev-log-header">
                <span class="dev-log-stage">${log.stage}</span>
                <span class="dev-log-timestamp">${time}</span>
              </div>
              <div class="dev-log-message">${log.message}</div>
              ${log.data ? `
                <div class="dev-log-data" id="data-${log.id}" style="display: none;">
                  ${JSON.stringify(log.data, null, 2)}
                </div>
                <button class="dev-log-expand" onclick="devLogger.toggleData('${log.id}')">
                  📄 Show Data
                </button>
              ` : ''}
            </div>
          `;
        }).join('');
      }
      
      renderRequestLogs() {
        const container = document.getElementById('devRequestLogs');
        const logs = this.logs.requests.slice(-10);
        
        container.innerHTML = logs.map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          
          return `
            <div class="dev-log-entry">
              <div class="dev-log-header">
                <span class="dev-log-stage">${log.stage}</span>
                <span class="dev-log-timestamp">${time}</span>
              </div>
              <div class="dev-log-message">${log.method} ${log.url}</div>
              <div class="dev-log-data" id="req-${log.id}" style="display: none;">
                <strong>Headers:</strong>
                ${JSON.stringify(log.headers, null, 2)}
                
                <strong>Body:</strong>
                ${typeof log.body === 'string' ? log.body : JSON.stringify(log.body, null, 2)}
              </div>
              <button class="dev-log-expand" onclick="devLogger.toggleData('req-${log.id}')">
                📄 Show Request
              </button>
            </div>
          `;
        }).join('');
      }
      
      renderResponseLogs() {
        const container = document.getElementById('devResponseLogs');
        const logs = this.logs.responses.slice(-10);
        
        container.innerHTML = logs.map(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          
          return `
            <div class="dev-log-entry ${log.status >= 400 ? 'error' : 'success'}">
              <div class="dev-log-header">
                <span class="dev-log-stage">${log.stage}</span>
                <span class="dev-log-timestamp">${time}</span>
              </div>
              <div class="dev-log-message">Status: ${log.status}</div>
              <div class="dev-log-data" id="res-${log.id}" style="display: none;">
                <strong>Headers:</strong>
                ${JSON.stringify(log.headers, null, 2)}
                
                <strong>Body:</strong>
                ${typeof log.body === 'string' ? log.body.substring(0, 2000) + (log.body.length > 2000 ? '...' : '') : JSON.stringify(log.body, null, 2)}
              </div>
              <button class="dev-log-expand" onclick="devLogger.toggleData('res-${log.id}')">
                📄 Show Response
              </button>
            </div>
          `;
        }).join('');
      }
      
      renderStatsTab() {
        const container = document.getElementById('devStatsContent');
        const uptime = Math.round((Date.now() - this.logs.stats.startTime) / 1000);
        
        container.innerHTML = `
          <div class="dev-stats">
            <div class="dev-stat">
              <div class="dev-stat-value">${uptime}s</div>
              <div class="dev-stat-label">Uptime</div>
            </div>
            <div class="dev-stat">
              <div class="dev-stat-value">${this.logs.pipeline.length}</div>
              <div class="dev-stat-label">Total Logs</div>
            </div>
            <div class="dev-stat">
              <div class="dev-stat-value">${this.logs.stats.success > 0 ? Math.round((this.logs.stats.success / this.logs.stats.pipelines) * 100) : 0}%</div>
              <div class="dev-stat-label">Success Rate</div>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <h4 style="color: white; margin-bottom: 10px;">📈 Performance Metrics</h4>
            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">
              • Average pipeline time: ${this.logs.stats.pipelines > 0 ? Math.round(uptime / this.logs.stats.pipelines) : 0}s<br/>
              • API calls per pipeline: ${this.logs.stats.pipelines > 0 ? Math.round(this.logs.stats.apiCalls / this.logs.stats.pipelines * 100) / 100 : 0}<br/>
              • Error rate: ${this.logs.stats.pipelines > 0 ? Math.round((this.logs.stats.errors / this.logs.stats.pipelines) * 100) : 0}%
            </div>
          </div>
        `;
      }
      
      toggleData(id) {
        // Handle different ID patterns
        let element = null;
        let buttonSelector = null;
        
        if (id.startsWith('data-')) {
          element = document.getElementById(id);
          buttonSelector = `button[onclick*="${id}"]`;
        } else if (id.startsWith('req-')) {
          element = document.getElementById(id);
          buttonSelector = `button[onclick*="${id}"]`;
        } else if (id.startsWith('res-')) {
          element = document.getElementById(id);
          buttonSelector = `button[onclick*="${id}"]`;
        } else {
          // Try all patterns
          element = document.getElementById(`data-${id}`) || 
                   document.getElementById(`req-${id}`) || 
                   document.getElementById(`res-${id}`);
          buttonSelector = `button[onclick*="${id}"]`;
        }
        
        if (!element) {
          console.warn('DevLogger: Element not found for ID:', id);
          return;
        }
        
        // Find button by onclick attribute instead of DOM position
        const button = document.querySelector(buttonSelector);
        
        if (!button) {
          console.warn('DevLogger: Button not found for ID:', id);
          return;
        }
        
        if (element.style.display === 'none') {
          element.style.display = 'block';
          button.textContent = '📄 Hide Data';
        } else {
          element.style.display = 'none';
          button.textContent = '📄 Show Data';
        }
      }
      
      setupEventListeners() {
        document.getElementById('devMinimizeBtn').addEventListener('click', () => this.minimize());
        document.getElementById('devCloseBtn').addEventListener('click', () => this.hide());
        document.getElementById('devClearBtn').addEventListener('click', () => this.clear());
        
        // Tab switching
        document.querySelectorAll('.dev-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            document.querySelectorAll('.dev-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dev-tab-content').forEach(c => c.style.display = 'none');
            
            e.target.classList.add('active');
            this.currentTab = e.target.dataset.tab;
            document.getElementById(`devTab${this.currentTab.charAt(0).toUpperCase() + this.currentTab.slice(1)}`).style.display = 'block';
            this.updateCurrentTab();
          });
        });
      }
      
      makeDraggable() {
        const header = document.getElementById('devLoggerHeader');
        const window = document.getElementById('devLoggerWindow');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        header.addEventListener('mousedown', (e) => {
          // Don't drag if clicking on buttons
          if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
          
          initialX = e.clientX - xOffset;
          initialY = e.clientY - yOffset;
          isDragging = true;
          
          // Add visual feedback
          window.style.opacity = '0.9';
          window.style.zIndex = '2000';
          header.style.cursor = 'grabbing';
          
          e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
          if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
            xOffset = currentX;
            yOffset = currentY;
            
            // Constrain to viewport
            const maxX = window.innerWidth - window.offsetWidth;
            const maxY = window.innerHeight - window.offsetHeight;
            currentX = Math.max(0, Math.min(currentX, maxX));
            currentY = Math.max(0, Math.min(currentY, maxY));
            
            window.style.transform = `translate(${currentX}px, ${currentY}px)`;
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            window.style.opacity = '1';
            window.style.zIndex = '1500';
            header.style.cursor = 'grab';
          }
        });
      }
    }
    
    // Context Templates (customizable by user)
    let customContexts = {
      general: {
        systemPrompt: 'You are a helpful AI assistant. Answer questions clearly and informatively.',
        userTemplate: 'Question: {prompt}\n\nAnswer this question clearly and informatively (maximum 10 lines). Be direct and helpful.'
      },
      creative: {
        systemPrompt: 'You are a p5.js creative coding assistant specialized in generating compact, creative p5.js code that creates visual art and animations. Always respond in JSON format with working code.',
        userTemplate: `Create p5.js code for: {prompt}

REQUIREMENTS:
1. Use compact syntax with t=0 and draw=_=>{...} pattern
2. Always include t||createCanvas(w=800,h=600) for setup
3. Use t+=0.01 to 0.1 for animation timing
4. Create visually interesting patterns using sin(), cos(), loops
5. Use fill() and stroke() for colors
6. Available functions: ellipse(), rect(), line(), point(), triangle(), arc()
7. Use mathematical patterns: sin(t+i), cos(t*2+i*0.1), etc.

EXAMPLES:
- Spiral: for(i=0;i<100;i++){x=400+cos(t+i*0.1)*i*2; y=300+sin(t+i*0.1)*i*2; ellipse(x,y,5)}
- Particles: for(i=0;i<50;i++){ellipse(400+sin(t+i)*100, 300+cos(t+i*0.5)*100, 8)}
- Waves: for(i=0;i<800;i+=10){ellipse(i, 300+sin(i*0.02+t)*50, 6)}

Return response as JSON:
{
  "code": "t=0\\ndraw=_=>{\\n  t||createCanvas(w=800,h=600)\\n  background(0,20)\\n  t+=0.05\\n  // your creative code here\\n}",
  "description": "Brief description of the animation"
}`
      },
      // Qwen-specific chat templates
      qwen: {
        general: {
          buildPrompt: (systemPrompt, userMessage) => `<|im_start|>system\n${systemPrompt}<|im_end|>\n<|im_start|>user\n${userMessage}<|im_end|>\n<|im_start|>assistant\n`,
          parseResponse: (response, fullPrompt) => response.replace(fullPrompt, '').replace(/<\|im_end\|>/g, '').trim()
        },
        creative: {
          buildPrompt: (systemPrompt, userMessage) => `<|im_start|>system\n${systemPrompt}<|im_end|>\n<|im_start|>user\n${userMessage}<|im_end|>\n<|im_start|>assistant\n`,
          parseResponse: (response, fullPrompt) => response.replace(fullPrompt, '').replace(/<\|im_end\|>/g, '').trim()
        }
      }
    };
    
    // Design files mapping
    const designs = {
      fish: 'lib/Designs/fish.js',
      bird: 'lib/Designs/bird.js',
      rabbit: 'lib/Designs/rabbit.js',
      spiral: 'lib/Designs/spiral.js',
      'cosmic-spiral': 'lib/Designs/cosmic-spiral.js'
    };

    // AI System Prompt - Teaches Gemini Nano about SketchPad-SLM
    const SYSTEM_PROMPT = `You are an AI assistant for SketchPad-SLM, a creative coding studio that uses p5.js with compact JavaScript syntax.

IMPORTANT RULES:
1. Always generate COMPACT p5.js code that works in our editor
2. Use the specific syntax patterns shown below
3. Keep code concise and creative
4. Focus on visual/generative art patterns

REQUIRED CODE STRUCTURE:
- Use compact syntax: t=0,draw=_=>{...}
- Always include: t||createCanvas(w,h) for setup
- Use global variables: t (time), w/h (dimensions)
- Animation: increment t each frame
- Drawing: use p5.js functions like point(), ellipse(), stroke(), fill()

EXAMPLES OF GOOD CODE:
1. Simple animation:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0)
  t+=0.05
  fill(sin(t)*127+128,cos(t)*127+128,255)
  ellipse(w/2+sin(t)*100,h/2+cos(t)*100,50,50)
}

2. Particle system:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.02
  for(i=0;i<100;i++){
    x=w/2+sin(t+i)*i*2
    y=h/2+cos(t+i*0.1)*i*2
    fill(i*2,255-i*2,255)
    ellipse(x,y,5,5)
  }
}

AVAILABLE FUNCTIONS:
- Drawing: point(), line(), ellipse(), rect(), arc(), triangle()
- Color: fill(), stroke(), noFill(), noStroke(), background()
- Math: sin(), cos(), noise(), random(), mag(), PI, TWO_PI
- Canvas: createCanvas(), strokeWeight()

When user asks for something, generate creative, compact p5.js code that creates visual art matching their request.`;







    // Update AI Connection Status in Header
    function updateHeaderAIStatus() {
      const headerStatus = document.getElementById('headerAIStatus');
      const connectBtn = document.getElementById('initAIBtn');
      const disconnectBtn = document.getElementById('disconnectAIBtn');
      
      if (aiSession) {
        if (aiSession.type === 'qwen') {
          headerStatus.textContent = '🧠 Qwen2.5 Connected';
          headerStatus.style.color = '#4CAF50';
        } else if (aiSession.type === 'openai') {
          headerStatus.textContent = `🚀 ${aiSession.model} Connected`;
          headerStatus.style.color = '#4CAF50';
        } else if (aiSession.type === 'lmstudio') {
          headerStatus.textContent = `🏠 LM Studio Connected`;
          headerStatus.style.color = '#4CAF50';
        } else if (aiSession.type === 'ollama') {
          headerStatus.textContent = `🦙 Ollama Connected`;
          headerStatus.style.color = '#4CAF50';
        }
        connectBtn.style.display = 'none';
        disconnectBtn.style.display = 'inline-block';
      } else {
        headerStatus.textContent = 'AI Integration';
        headerStatus.style.color = 'rgba(255,255,255,0.85)';
        connectBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'none';
      }
    }

    // Disconnect AI
    function disconnectAI() {
      if (aiSession) {
        const wasConnected = aiSession !== null;
        const aiType = aiSession.type || 'unknown';
        
              // Clear AI session
      aiSession = null;
      
      // Clear agent system
      canvaCore = null;
      
      // Reset UI elements
      document.getElementById('aiStatus').textContent = 'AI: Disconnected';
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('initAIBtn').textContent = '🔌 Connect';
      
      // Update header status
      updateHeaderAIStatus();
      
      // Clear API key from memory
      openaiApiKey = '';
      
      // Add chat message
      addChatMessage('system', `🔌 AI disconnected. ${aiType === 'qwen' ? 'Qwen2.5' : aiType === 'openai' ? 'OpenAI API + Agent System' : aiType === 'lmstudio' ? 'LM Studio' : 'AI'} session ended.`);
      updateStatus('🔌 AI disconnected successfully');
        
        // Track disconnection
        if (window.AppConfig && wasConnected) {
          window.AppConfig.trackEvent('ai_disconnected', 'ai_interaction', aiType);
        }
        
        console.log('🔌 AI Session Disconnected:', aiType);
      }
    }



    // Initialize AI with Multiple Options
    async function initializeAI() {
      try {
        updateStatus('🤖 Initializing AI system...');
        document.getElementById('aiStatus').textContent = 'AI: Checking...';
        
        // Mark that user explicitly wants to initialize AI
        pendingAIInitialization = true;
        
        // Check if user has accepted agreement
        if (!window.userAgreement.isAgreementAccepted()) {
          console.log('🔒 User explicitly requested AI - showing agreement first');
          window.userAgreement.showUserAgreement();
          return;
        }
        
        // User has accepted agreement and explicitly wants AI - show selection modal
        console.log('✅ User explicitly requested AI and agreement is accepted - showing AI selection');
        pendingAIInitialization = false; // Reset flag since we're proceeding
        showAISelectionModal();
        
      } catch (error) {
        console.error('AI initialization error:', error);
        pendingAIInitialization = false; // Reset flag on error
        fallbackToTemplates();
      }
    }

    // Show AI selection modal
    function showAISelectionModal() {
      // Don't show if user hasn't accepted agreement
      if (!window.userAgreement.isAgreementAccepted()) {
        console.log('⚠️ User agreement not accepted - cannot show AI selection modal');
        window.userAgreement.showUserAgreement();
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'ai-selection-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 2000; display: flex;
        align-items: center; justify-content: center;
      `;
      
      if (aiProvider === 'openai') {
        // OpenAI API Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
              <h2 style="color: white; margin-bottom: 20px; text-align: center;">🚀 OpenAI API Models</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 10px; display: block;">Select Model:</label>
                <select id="apiModelSelect" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
                                                   border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; 
                                                   color: white; font-size: 14px;">
                  <option value="gpt-4.1-nano">GPT-4.1 Nano (Ultra Fast & Efficient)</option>
                </select>
              </div>
              
              <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 20px; text-align: center;">
                📝 Requires valid OpenAI API key<br/>
                💰 API usage charges apply based on your OpenAI plan
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="connectApiModel" class="ai-option-btn" style="flex: 1;">
                  🔌 Connect OpenAI API
              </button>
            </div>
              
              <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                      color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                      float: right; margin-top: 10px;">Cancel</button>
            </div>
          `;
      } else if (aiProvider === 'lmstudio') {
        // LM Studio Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
              <h2 style="color: white; margin-bottom: 20px; text-align: center;">🏠 LM Studio Connection</h2>
            
            <div style="margin-bottom: 20px;">
                <button id="connectLMStudio" class="ai-option-btn">
                  🔌 Connect to LM Studio
              </button>
              <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
                  Connects to LM Studio running on localhost:1234
              </p>
            </div>
              
              <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px; text-align: center;">
                📋 Requirements:<br/>
                • LM Studio must be running on port 1234<br/>
                • A model must be loaded in LM Studio<br/>
                • CORS must be enabled in LM Studio settings<br/>
                • No API key required - fully local
              </div>
            
            <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                    color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                    float: right; margin-top: 10px;">Cancel</button>
          </div>
        `;
      } else if (aiProvider === 'ollama') {
        // Ollama Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #00d4aa 0%, #00a67d 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
              <h2 style="color: white; margin-bottom: 20px; text-align: center;">🦙 Ollama Connection</h2>
            
            <div style="margin-bottom: 20px;">
                <button id="connectOllama" class="ai-option-btn">
                  🔌 Connect to Ollama
              </button>
              <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
                  Connects to Ollama running on localhost:11434
              </p>
            </div>
              
              <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px; text-align: center;">
                📋 Requirements:<br/>
                • Ollama must be installed and running<br/>
                • Qwen 2.5:0.5b or Qwen 3:0.6b model must be pulled<br/>
                • Example: <code style="background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px;">ollama pull qwen2.5:0.5b</code><br/>
                • No API key required - fully local
              </div>
            
            <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                    color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                    float: right; margin-top: 10px;">Cancel</button>
          </div>
        `;
      } else {
        // Local Qwen2.5 Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h2 style="color: white; margin-bottom: 20px; text-align: center;">🤖 Local Qwen2.5</h2>
          
          <div style="margin-bottom: 20px;">
              <button id="selectJanus" class="ai-option-btn">
                🚀 Load Qwen2.5-0.5B (~500MB)
            </button>
            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
                Optimized inference with proper generation parameters. No API costs.
            </p>
          </div>
            
            <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px; text-align: center;">
              ⚠️ Requires WebGPU support and 2GB+ RAM<br/>
              Model cached after first download for instant future loading
            </div>
          
          <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                  color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                  float: right; margin-top: 10px;">Cancel</button>
        </div>
      `;
      }
      
      const style = document.createElement('style');
      style.textContent = `
        .ai-option-btn {
          width: 100%; padding: 15px; margin: 5px 0; background: rgba(255,255,255,0.1);
          border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white;
          font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .ai-option-btn:hover {
          background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5);
          transform: translateY(-2px);
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Event listeners
      if (aiProvider === 'openai') {
        document.getElementById('connectApiModel').onclick = () => {
          const selectedModel = document.getElementById('apiModelSelect').value;
          document.body.removeChild(modal);
          initializeApiModel(selectedModel);
        };
      } else if (aiProvider === 'lmstudio') {
        document.getElementById('connectLMStudio').onclick = () => {
          document.body.removeChild(modal);
          initializeLMStudio();
        };
      } else if (aiProvider === 'ollama') {
        document.getElementById('connectOllama').onclick = () => {
          document.body.removeChild(modal);
          initializeOllama();
        };
      } else {
        document.getElementById('selectJanus').onclick = () => {
          document.body.removeChild(modal);
          initializeJanus();
        };
      }
      
      document.getElementById('closeModal').onclick = () => {
        document.body.removeChild(modal);
        updateStatus('AI initialization cancelled');
        addChatMessage('system', 'AI initialization cancelled.');
      };
    }



    // Initialize API Model (OpenAI)
    async function initializeApiModel(modelName) {
      try {
        updateStatus('🚀 Connecting to OpenAI API...');
        document.getElementById('aiStatus').textContent = 'AI: Connecting to API...';
        
        // Check if API key is provided
        const apiKey = document.getElementById('openaiApiKey').value.trim();
        if (!apiKey) {
          addChatMessage('system', '❌ OpenAI API Key required. Please enter your API key in the left panel.');
          document.getElementById('aiStatus').textContent = 'AI: API Key Required ❌';
          updateStatus('❌ API Key required');
          return;
        }
        
        // Store API key for session
        openaiApiKey = apiKey;
        
        // Test API connection with a simple request
        console.log('🔍 Testing OpenAI API connection...');
        const testResponse = await fetch('https://api.openai.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!testResponse.ok) {
          console.error('❌ API connection test failed:', testResponse.status, testResponse.statusText);
          throw new Error(`API Key validation failed: ${testResponse.status} ${testResponse.statusText}`);
    }

        const modelsData = await testResponse.json();
        console.log('✅ API connection test passed! Available models:', modelsData.data?.length || 'Unknown count');
        console.log('🔑 API Key validated successfully');
        
        aiSession = { type: 'openai', model: modelName, apiKey: apiKey };
        document.getElementById('aiStatus').textContent = `AI: ${modelName} ✅`;
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = `🚀 ${modelName} Ready`;
        
        // Initialize CanvaCore agent system
        try {
          if (window.CanvaCore) {
            canvaCore = new window.CanvaCore();
            console.log('🎯 CanvaCore: Multi-agent system initialized');
            addChatMessage('system', '🎯 CanvaCore: Advanced multi-agent system activated! CanvaScan + CanvaArtist ready for enhanced code generation.');
          } else {
            console.warn('CanvaCore not available, using standard generation');
            addChatMessage('system', '⚠️ Agent system not loaded, using standard OpenAI generation');
          }
        } catch (agentError) {
          console.error('Agent system initialization failed:', agentError);
          addChatMessage('system', '⚠️ Agent system initialization failed, using standard generation');
          canvaCore = null;
        }
        
        // Update header status
        updateHeaderAIStatus();
        
        console.log(`🚀 ${modelName} session initialized successfully`);
        updateStatus(`🚀 ${modelName} connected successfully!`);
        addChatMessage('system', `🚀 ${modelName} connected! Advanced AI capabilities are now available. API usage charges apply.`);
        
        // Track API model connection
        if (window.AppConfig) {
          window.AppConfig.trackEvent('api_model_connected', 'ai_interaction', modelName);
        }
        
      } catch (error) {
        console.error('API Model initialization error:', error);
        addChatMessage('system', `❌ Failed to connect to OpenAI API: ${error.message}`);
        document.getElementById('aiStatus').textContent = 'AI: API Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ API Failed';
        updateStatus('❌ API connection failed');
      }
    }

    // Initialize LM Studio
    async function initializeLMStudio() {
      try {
        updateStatus('🏠 Connecting to LM Studio...');
        document.getElementById('aiStatus').textContent = 'AI: Connecting to LM Studio...';
        
        // Test LM Studio connection by fetching models
        console.log('🔍 Testing LM Studio connection...');
        const testResponse = await fetch('http://localhost:1234/v1/models', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors'
        });
        
        if (!testResponse.ok) {
          console.error('❌ LM Studio connection test failed:', testResponse.status, testResponse.statusText);
          throw new Error(`LM Studio connection failed: ${testResponse.status} ${testResponse.statusText}. Make sure LM Studio is running on port 1234 and CORS is enabled.`);
        }

        const modelsData = await testResponse.json();
        console.log('✅ LM Studio connection test passed! Available models:', modelsData.data?.length || 'Unknown count');
        
        // Get the first available model
        const availableModel = modelsData.data?.[0]?.id || 'lm-studio-model';
        
        aiSession = { type: 'lmstudio', model: availableModel, baseURL: 'http://localhost:1234/v1' };
        document.getElementById('aiStatus').textContent = `AI: LM Studio (${availableModel}) ✅`;
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = `🏠 LM Studio Ready`;
        
        // Update header status
        updateHeaderAIStatus();
        
        console.log(`🏠 LM Studio session initialized successfully with model: ${availableModel}`);
        updateStatus(`🏠 LM Studio connected successfully!`);
        addChatMessage('system', `🏠 LM Studio connected! Using model: ${availableModel}. Fully local processing - no API costs.`);
        
        // Track LM Studio connection
        if (window.AppConfig) {
          window.AppConfig.trackEvent('lmstudio_connected', 'ai_interaction', availableModel);
        }
        
      } catch (error) {
        console.error('LM Studio initialization error:', error);
        
        let errorMessage = `❌ Failed to connect to LM Studio: ${error.message}`;
        if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
          errorMessage += `\n\n💡 CORS Fix: In LM Studio, go to Settings → Server → Enable CORS, then restart the server.`;
        }
        
        addChatMessage('system', errorMessage);
        document.getElementById('aiStatus').textContent = 'AI: LM Studio Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ LM Studio Failed';
        updateStatus('❌ LM Studio connection failed - Check CORS settings');
      }
    }

    // Initialize Ollama
    async function initializeOllama() {
      try {
        updateStatus('🦙 Connecting to Ollama...');
        document.getElementById('aiStatus').textContent = 'AI: Connecting to Ollama...';
        
        // Test Ollama connection by fetching models
        console.log('🔍 Testing Ollama connection...');
        const testResponse = await fetch('http://localhost:11434/api/tags', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors'
        });
        
        if (!testResponse.ok) {
          console.error('❌ Ollama connection test failed:', testResponse.status, testResponse.statusText);
          throw new Error(`Ollama connection failed: ${testResponse.status} ${testResponse.statusText}. Make sure Ollama is running on port 11434.`);
        }

        const modelsData = await testResponse.json();
        console.log('✅ Ollama connection test passed! Available models:', modelsData.models?.length || 'Unknown count');
        
        // Find the best available Qwen model (prioritize newer versions)
        let selectedModel = null;
        const modelPriority = ['qwen2.5:7b', 'qwen2.5:3b', 'qwen2.5:1.5b', 'qwen2.5:0.5b', 'qwen:7b', 'qwen:4b', 'qwen:1.8b'];
        
        for (const priority of modelPriority) {
          const found = modelsData.models?.find(m => m.name.includes(priority.split(':')[0]));
          if (found) {
            selectedModel = found.name;
            break;
          }
        }
        
        // Fallback to first available model or default
        if (!selectedModel) {
          selectedModel = modelsData.models?.[0]?.name || 'qwen2.5:0.5b';
        }
        
        aiSession = { type: 'ollama', model: selectedModel, baseURL: 'http://localhost:11434' };
        document.getElementById('aiStatus').textContent = `AI: Ollama (${selectedModel}) ✅`;
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = `🦙 Ollama Ready`;
        
        // Update header status
        updateHeaderAIStatus();
        
        console.log(`🦙 Ollama session initialized successfully with model: ${selectedModel}`);
        updateStatus(`🦙 Ollama connected successfully!`);
        addChatMessage('system', `🦙 Ollama connected! Using model: ${selectedModel}. Fully local processing with GGUF models - no API costs.`);
        
        // Track Ollama connection
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ollama_connected', 'ai_interaction', selectedModel);
        }
        
      } catch (error) {
        console.error('Ollama initialization error:', error);
        
        let errorMessage = `❌ Failed to connect to Ollama: ${error.message}`;
        if (error.message.includes('Failed to fetch')) {
          errorMessage += `\n\n💡 Make sure Ollama is installed and running: \n1. Install Ollama from https://ollama.ai\n2. Run: ollama serve\n3. Pull a Qwen model: ollama pull qwen2.5:0.5b`;
        }
        
        addChatMessage('system', errorMessage);
        document.getElementById('aiStatus').textContent = 'AI: Ollama Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ Ollama Failed';
        updateStatus('❌ Ollama connection failed - Check installation and model');
      }
    }

    // Initialize Qwen2.5
    async function initializeJanus() {
      try {
        updateStatus('🚀 Loading Qwen2.5-0.5B (~500MB)...');
        document.getElementById('aiStatus').textContent = 'AI: Loading Qwen2.5...';
        
        // Check browser compatibility
        const hasFloat16 = typeof Float16Array !== 'undefined';
        if (!hasFloat16) {
          addChatMessage('system', '⚠️ Your browser lacks Float16Array support. Using q4 quantization instead of q4f16 for better compatibility.');
        }
        
        // Show loading screen
        showLoadingScreen();
        
        // Import Transformers.js
        updateLoadingProgress(10, 'Importing Transformers.js...');
        
        // Temporarily suppress verbose ONNX warnings during loading
        const originalWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          if (message.includes('VerifyEachNodeIsAssignedToAnEp') || 
              message.includes('Some nodes were not assigned') ||
              message.includes('Rerunning with verbose output')) {
            return; // Suppress these specific warnings
          }
          originalWarn.apply(console, args);
        };
        
        const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.1.0');
        
        const MODEL = 'Qwen/Qwen2-0.5B-Instruct';
        
        // Use pipeline approach for better reliability
        updateLoadingProgress(20, 'Loading Qwen2.5 model...');
        
        let generator;
        
        try {
          updateLoadingProgress(50, 'Loading with WebGPU acceleration...');
          addChatMessage('system', '🚀 Starting Qwen2.5 model download (~500MB). This may take 2-5 minutes...');
          
          generator = await pipeline('text-generation', MODEL, {
            dtype: 'q4',
            device: 'webgpu',
            progress_callback: (progress) => {
              try {
                if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                  const percent = 50 + (progress.progress * 45);
                  const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                  updateLoadingProgress(percent, `Loading model: ${fileName}`);
                }
              } catch (e) {
                console.warn('Progress callback error:', e);
              }
            }
          });
          
          addChatMessage('system', '🎉 Qwen2.5 loaded successfully! WebGPU acceleration active.');
        } catch (webgpuError) {
          console.warn('WebGPU loading failed, trying CPU fallback:', webgpuError);
          
          try {
            updateLoadingProgress(50, 'WebGPU failed, loading with CPU...');
            addChatMessage('system', '⚠️ WebGPU failed, falling back to CPU...');
            
            generator = await pipeline('text-generation', MODEL, {
              dtype: 'q8',
              device: 'cpu',
              progress_callback: (progress) => {
                try {
                  if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                    const percent = 50 + (progress.progress * 45);
                    const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                    updateLoadingProgress(percent, `Loading model (CPU): ${fileName}`);
                  }
                } catch (e) {
                  console.warn('Progress callback error:', e);
                }
              }
            });
            
            addChatMessage('system', '🎉 Qwen2.5 loaded successfully on CPU!');
          } catch (cpuError) {
            console.error('Both WebGPU and CPU loading failed:', cpuError);
            addChatMessage('system', '❌ Model loading failed. AI is disabled.');
            document.getElementById('aiStatus').textContent = 'AI: Load Failed ❌';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('initAIBtn').textContent = '❌ Load Failed';
            hideLoadingScreen();
            updateStatus('❌ Model failed to load. AI disabled.');
            return;
          }
        }
        
        updateLoadingProgress(95, 'Finalizing model setup...');
        aiSession = { type: 'qwen', generator };
        document.getElementById('aiStatus').textContent = 'AI: Qwen2.5-0.5B ✅';
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = '🚀 Qwen2.5 Ready';
        
        // Update header status
        updateHeaderAIStatus();
        
        // Restore console.warn
        console.warn = originalWarn;
        
        updateLoadingProgress(100, 'Model loaded successfully!');
        setTimeout(() => {
          hideLoadingScreen();
          updateStatus('🚀 Qwen2.5-0.5B loaded successfully!');
          addChatMessage('system', '🚀 Qwen2.5-0.5B loaded successfully! Ready to generate creative p5.js code with optimized inference parameters.');
          
          // Track successful AI loading
          if (window.AppConfig) {
            window.AppConfig.trackEvent('ai_model_loaded', 'ai_interaction', 'qwen2.5_success');
          }
        }, 500);
        
      } catch (error) {
        console.error('Qwen2.5 initialization error:', error);
        
        // Restore console.warn in case of error
        if (typeof originalWarn !== 'undefined') {
          console.warn = originalWarn;
        }
        
        hideLoadingScreen();
        addChatMessage('system', `❌ Failed to load Qwen2.5: ${error.message}. AI is disabled.`);
        document.getElementById('aiStatus').textContent = 'AI: Load Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ Load Failed';
        updateStatus('❌ Model failed to load. AI disabled.');
      }
    }

    // Show loading screen
    function showLoadingScreen() {
      const loadingScreen = document.createElement('div');
      loadingScreen.id = 'loadingScreen';
      loadingScreen.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 3000; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
      `;
      
              loadingScreen.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.5); text-align: center;">
          <div style="color: white; font-size: 24px; font-weight: 600; margin-bottom: 20px;">
            🚀 Loading Qwen2.5-0.5B
          </div>
          <div style="color: rgba(255,255,255,0.8); margin-bottom: 30px;">
            Optimized inference: ~500MB • High quality • Cached for future use
          </div>
          
          <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 20px; 
                      margin-bottom: 15px; overflow: hidden;">
            <div id="progressBar" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); 
                                        height: 100%; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          
          <div id="progressText" style="color: rgba(255,255,255,0.9); font-size: 14px;">
            Initializing...
          </div>
          <div id="progressPercent" style="color: white; font-size: 18px; font-weight: 600; margin-top: 10px;">
            0%
          </div>
        </div>
      `;
      
      document.body.appendChild(loadingScreen);
    }

    // Update loading progress
    function updateLoadingProgress(percent, message) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      
      // Validate and clamp percentage
      const validPercent = Math.max(0, Math.min(100, Math.round(percent || 0)));
      
      if (progressBar) progressBar.style.width = validPercent + '%';
      if (progressText) progressText.textContent = message || 'Loading...';
      if (progressPercent) progressPercent.textContent = validPercent + '%';
      
      // Log progress for debugging
      console.log(`Loading progress: ${validPercent}% - ${message}`);
    }

    // Hide loading screen
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transform = 'scale(0.9)';
        loadingScreen.style.transition = 'all 0.3s ease';
        setTimeout(() => {
          if (loadingScreen.parentNode) {
            loadingScreen.parentNode.removeChild(loadingScreen);
          }
        }, 300);
      }
    }



    // Generate code using AI (Qwen2.5 or OpenAI API)
    async function generateAICode(userPrompt) {
      if (!aiSession) {
        updateStatus('❌ AI not connected. Click "Connect AI" first.');
        return;
      }
      
      if (aiSession !== 'template' && aiSession.type !== 'qwen' && aiSession.type !== 'openai' && aiSession.type !== 'lmstudio' && aiSession.type !== 'ollama') {
        updateStatus('❌ Invalid AI session type.');
        addChatMessage('ai', 'AI session error. Please reconnect.');
        return;
      }

      try {
        // Console log user input (pretty formatted)
        console.log('%c📝 USER INPUT', 'background: #4facfe; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', userPrompt);
        
        // Add user message to chat
        addChatMessage('user', userPrompt);
        
        // Handle different chat modes
        if (chatMode === 'general') {
          return await handleGeneralChat(userPrompt);
        } else {
          return await handleCreativeChat(userPrompt);
        }
        
      } catch (error) {
        console.error('AI generation error:', error);
        updateStatus('❌ AI generation failed: ' + error.message);
        addChatMessage('ai', `Error: ${error.message}. Please try again.`);
      }
    }

    // Handle general chat (no code generation)
    async function handleGeneralChat(userPrompt) {
      updateStatus('🤖 AI is thinking...');
      
      let aiResponse = '';
      
      // AI Model handling - General conversation  
      if (aiSession.type === 'qwen') {
        try {
          // Create proper Qwen2 chat format
          const systemPrompt = customContexts.general.systemPrompt;
          const userMessage = customContexts.general.userTemplate.replace('{prompt}', userPrompt);
          
          const fullPrompt = `<|im_start|>system\n${systemPrompt}<|im_end|>\n<|im_start|>user\n${userMessage}<|im_end|>\n<|im_start|>assistant\n`;
          
          // Log the actual formatted prompt being sent to AI
          console.log('%c🔍 ACTUAL QUERY (Qwen2.5 General)', 'background: #a8edea; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
          console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', fullPrompt);
          
          const result = await aiSession.generator(fullPrompt, {
            max_new_tokens: 200,
            temperature: 0.7,
            do_sample: true,
            top_p: 0.9,
            repetition_penalty: 1.1
          });
          
          // Extract generated text and clean it up
          aiResponse = result[0].generated_text.replace(fullPrompt, '').trim();
          
          // Console log raw AI response before cleanup
          console.log('%c🤖 RAW AI RESPONSE (Qwen2.5 General)', 'background: #fa709a; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', aiResponse);
          
          // Clean up response
          aiResponse = aiResponse.replace(/<\|im_end\|>/g, '').trim();
          
          // Take first reasonable paragraph if response is too long
          const sentences = aiResponse.split(/[.!?]+/);
          if (sentences.length > 5) {
            aiResponse = sentences.slice(0, 5).join('.') + '.';
          }
          
          // Validate response quality
          if (aiResponse.length < 5 || aiResponse.includes('calcuttonia') || 
              aiResponse.includes('hindi language country') ||
              aiResponse.toLowerCase().includes('new york city specifically')) {
            aiResponse = 'Sorry, the model generated an invalid response. Please try rephrasing your question.';
            console.log('%c🤖 Invalid AI Response Detected', 'background: #fed6e3; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;', 'Nonsensical output detected');
          }
          
          updateStatus('🚀 Qwen2.5 responded!');
          
        } catch (error) {
          console.error('General chat error:', error);
          aiResponse = `Model error: ${error.message}. Please try again or rephrase your question.`;
          console.log('%c🤖 Generation Error', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', error);
          updateStatus('❌ Model error during generation');
        }
              } else if (aiSession.type === 'openai') {
          try {
            // OpenAI API call for general chat
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${aiSession.apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: aiSession.model,
                messages: [
                  { role: 'system', content: customContexts.general.systemPrompt },
                  { role: 'user', content: customContexts.general.userTemplate.replace('{prompt}', userPrompt) }
                ],
                max_tokens: 500,
                temperature: 0.7
              })
            });
            
            if (!response.ok) {
              throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            aiResponse = data.choices[0].message.content.trim();
            
            // Console log raw OpenAI API response
            console.log('%c🚀 RAW OPENAI API RESPONSE (General Chat)', 'background: #00a67d; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
            console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
            console.log('%cExtracted Content:', 'color: #666; font-weight: bold;', aiResponse);
            
            updateStatus(`🚀 ${aiSession.model} responded!`);
            
                    } catch (error) {
            console.error('OpenAI API error:', error);
            aiResponse = `OpenAI API error: ${error.message}. Please check your API key and try again.`;
            updateStatus('❌ OpenAI API error');
          }
        } else if (aiSession.type === 'lmstudio') {
          try {
            // LM Studio API call for general chat
            const response = await fetch(`${aiSession.baseURL}/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              mode: 'cors',
              body: JSON.stringify({
                model: aiSession.model,
                messages: [
                  { role: 'system', content: customContexts.general.systemPrompt },
                  { role: 'user', content: customContexts.general.userTemplate.replace('{prompt}', userPrompt) }
                ],
                max_tokens: 500,
                temperature: 0.7
              })
            });
            
            if (!response.ok) {
              throw new Error(`LM Studio API error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            aiResponse = data.choices[0].message.content.trim();
            
            // Console log raw LM Studio API response
            console.log('%c🏠 RAW LM STUDIO RESPONSE (General Chat)', 'background: #4facfe; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
            console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
            console.log('%cExtracted Content:', 'color: #666; font-weight: bold;', aiResponse);
            
            updateStatus(`🏠 ${aiSession.model} responded!`);
            
          } catch (error) {
            console.error('LM Studio API error:', error);
            aiResponse = `LM Studio API error: ${error.message}. Please check that LM Studio is running on port 1234.`;
            updateStatus('❌ LM Studio API error');
          }
        } else if (aiSession.type === 'ollama') {
          try {
            // Build Qwen chat prompt using proper template
            const systemPrompt = customContexts.general.systemPrompt;
            const userMessage = customContexts.general.userTemplate.replace('{prompt}', userPrompt);
            const chatPrompt = customContexts.qwen.general.buildPrompt(systemPrompt, userMessage);
            
            // Console log the formatted prompt
            console.log('%c🦙 OLLAMA QUERY (General Chat)', 'background: #00d4aa; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
            console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', chatPrompt);
            
            // Ollama API call for general chat
            const response = await fetch(`${aiSession.baseURL}/api/generate`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              mode: 'cors',
              body: JSON.stringify({
                model: aiSession.model,
                prompt: chatPrompt,
                stream: false,
                options: {
                  temperature: 0.7,
                  top_p: 0.9,
                  max_tokens: 500,
                  stop: ['<|im_end|>']
                }
              })
            });
            
            if (!response.ok) {
              throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            const rawResponse = data.response || '';
            
            // Parse response using Qwen template
            aiResponse = customContexts.qwen.general.parseResponse(rawResponse, '');
            
            // Console log raw Ollama API response
            console.log('%c🦙 RAW OLLAMA RESPONSE (General Chat)', 'background: #00d4aa; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
            console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
            console.log('%cParsed Content:', 'color: #666; font-weight: bold;', aiResponse);
            
            updateStatus(`🦙 ${aiSession.model} responded!`);
            
          } catch (error) {
            console.error('Ollama API error:', error);
            aiResponse = `Ollama API error: ${error.message}. Please check that Ollama is running on port 11434.`;
            updateStatus('❌ Ollama API error');
          }
        } else {
          aiResponse = 'AI is not properly initialized. Please connect an AI model.';
          updateStatus('❌ AI not available');
        }
      
      // Add AI response to chat
      addChatMessage('ai', aiResponse);
    }

    // Handle creative chat (code generation)
    async function handleCreativeChat(userPrompt) {
      updateStatus('🤖 AI is generating code...');
      
      let code = '';
      let aiResponse = '';
        
        // AI Model handling - Code generation
        if (aiSession.type === 'openai' && canvaCore) {
          // Use advanced agent system for OpenAI
          try {
            updateStatus('🎯 CanvaCore: Multi-agent system activated...');
            addChatMessage('system', '🎯 CanvaCore: Starting advanced multi-agent code generation pipeline...');
            
            const result = await canvaCore.generateCode(userPrompt, aiSession);
            
            code = result.code;
            aiResponse = result.description;
            
            // Add metadata information to chat
            if (result.metadata) {
              const metaInfo = [];
              if (result.metadata.scanPassed === false) metaInfo.push('🔍 CanvaScan: Code repair applied');
              if (result.metadata.creativityEnhanced) metaInfo.push('🎨 CanvaArtist: Creativity enhanced');
              if (result.metadata.agentTries > 0) metaInfo.push(`🔄 Agent tries: ${result.metadata.agentTries}`);
              if (result.metadata.runtimeTested) metaInfo.push('🧪 Runtime execution tested');
              if (result.metadata.visualOutput) metaInfo.push('🎨 Visual output verified');
              if (result.metadata.executionVerified) metaInfo.push('✅ Execution verified');

              
              if (metaInfo.length > 0) {
                addChatMessage('system', metaInfo.join(' • '));
              }
            }
            
            updateStatus('✅ CanvaCore: Multi-agent generation completed!');
            
          } catch (error) {
            console.error('CanvaCore error:', error);
            addChatMessage('system', `❌ CanvaCore error: ${error.message}. Code generation failed.`);
            updateStatus('❌ CanvaCore pipeline failed');
            return; // Exit without generating code
          }
        } else if (aiSession.type === 'qwen') {
          let generationAttempts = 0;
          const maxGenerationAttempts = 3;
          let qwenSuccess = false;
          
          // Strategy: Clean pipeline-based generation
          while (!qwenSuccess && generationAttempts < maxGenerationAttempts) {
            try {
              generationAttempts++;
              
              // Create proper Qwen2 chat format  
              const systemPrompt = customContexts.creative.systemPrompt;
              const userMessage = customContexts.creative.userTemplate.replace('{prompt}', userPrompt);
              
              const fullPrompt = `<|im_start|>system\n${systemPrompt}<|im_end|>\n<|im_start|>user\n${userMessage}<|im_end|>\n<|im_start|>assistant\n`;
              
              // Log the actual formatted prompt being sent to AI
              console.log('%c🔍 ACTUAL QUERY (Qwen2.5 Creative - Attempt ' + generationAttempts + ')', 'background: #a8edea; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
              console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', fullPrompt);
              
              // Try with different generation parameters based on attempt
              let genParams = {
                max_new_tokens: 300,
                temperature: 0.8,
                do_sample: true,
                top_p: 0.9,
                repetition_penalty: 1.1
              };
              
              if (generationAttempts === 2) {
                // Second attempt: More conservative parameters
                genParams.temperature = 0.6;
                genParams.max_new_tokens = 250;
              } else if (generationAttempts === 3) {
                // Third attempt: Very conservative
                genParams.temperature = 0.4;
                genParams.max_new_tokens = 200;
                genParams.do_sample = false;
              }
              
              const result = await aiSession.generator(fullPrompt, genParams);
              const rawCode = result[0].generated_text.replace(fullPrompt, '').trim();
              
              // Console log raw AI output
              console.log('%c🤖 RAW AI RESPONSE (Qwen2.5 Creative - Attempt ' + generationAttempts + ')', 'background: #fa709a; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', rawCode);
              
              // Show raw AI output in chat for debugging
              addChatMessage('system', `🔍 Raw AI Output (attempt ${generationAttempts}):`, rawCode.substring(0, 200) + '...');
              
              // Clean up the response thoroughly
              code = rawCode.replace(/<\|im_end\|>/g, '').trim();
              
              // Remove code blocks and explanatory text
              code = code.replace(/```javascript\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```js\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```paddle_live_code\n?/g, '').replace(/```\n?/g, '');
              
              // Remove forbidden patterns that AI keeps generating
              if (code.includes('paddle') || code.includes('while(true)') || code.includes('gradient') || 
                  code.includes('time()') || code.includes('Math.') || code.includes('speed_')) {
                console.warn('AI generated forbidden patterns, forcing template fallback');
                throw new Error('AI generated forbidden patterns (paddle, while, gradient, etc.)');
              }
              
              // ULTRA-AGGRESSIVE EXTRACTION: Force our exact pattern
              // Strategy 1: Look for t=0 followed by draw function
              let codeMatch = code.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
              if (codeMatch) {
                code = codeMatch[1];
              } else {
                // Strategy 2: Look for draw function only and prepend t=0
                codeMatch = code.match(/(draw\s*=\s*[^{]*{[\s\S]*?})/);
                if (codeMatch) {
                  code = 't=0\n' + codeMatch[1];
                } else {
                  // Strategy 3: Look for any p5.js-like function calls
                  codeMatch = code.match(/(createCanvas|background|fill|stroke|ellipse|rect|point)[\s\S]*?}/);
                  if (codeMatch) {
                    // Build a proper p5.js structure around it
                    code = `t=0\ndraw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ${codeMatch[0]}\n}`;
                  } else {
                    // Strategy 4: If nothing works, throw error to trigger template fallback
                    throw new Error('No valid p5.js pattern found in AI response');
                  }
                }
              }
              
              // Remove any remaining HTML/markdown artifacts
              code = code.replace(/<[^>]*>/g, ''); // Remove HTML tags
              code = code.replace(/&[a-zA-Z0-9#]+;/g, ''); // Remove HTML entities
              
              // AGGRESSIVE TEXT REMOVAL: Remove explanatory sentences
              const lines = code.split('\n');
              const codeLines = [];
              let inCodeBlock = false;
              
              for (let line of lines) {
                const trimmed = line.trim();
                
                // Start of code block
                if (trimmed.startsWith('t=') || trimmed.startsWith('draw=')) {
                  inCodeBlock = true;
                }
                
                // Skip explanatory text
                if (!inCodeBlock) continue;
                
                // Skip lines that look like explanations
                if (trimmed && 
                    !trimmed.startsWith('//') &&
                    !trimmed.startsWith('*') &&
                    !trimmed.startsWith('#') &&
                    !trimmed.match(/^\d+\.?\s/) && // Skip numbered lists
                    !trimmed.toLowerCase().includes('this example') &&
                    !trimmed.toLowerCase().includes('to further') &&
                    !trimmed.toLowerCase().includes('note:') &&
                    !trimmed.toLowerCase().includes('represents') &&
                    !trimmed.toLowerCase().includes('defines what') &&
                    !trimmed.toLowerCase().includes('we keep track') &&
                    !trimmed.toLowerCase().includes('assumes all') &&
                    !trimmed.toLowerCase().includes('elaborat') &&
                    !/^(the|this|you|we|i|it|here|above|below)\s+/i.test(trimmed) &&
                    (trimmed.includes('=') || trimmed.includes('{') || trimmed.includes('}') || 
                     trimmed.includes('(') || trimmed.includes('for') || trimmed.includes('if'))) {
                  codeLines.push(line);
                }
                
                // End of code block
                if (trimmed === '}' && inCodeBlock) {
                  break;
                }
              }
              
              code = codeLines.join('\n').trim();
              
              // Final validation: ensure we have proper p5.js structure
              if (!code || code.length < 10) {
                addChatMessage('system', `⚠️ Extracted code too short: "${code}"`);
                throw new Error('No valid JavaScript code extracted from AI response');
              }
              
              // Force proper p5.js format if missing key components
              if (!code.includes('t=0')) {
                code = 't=0\n' + code;
              }
              if (!code.includes('draw=')) {
                code = code.replace(/^/, 'draw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ') + '\n}';
              }
              if (!code.includes('createCanvas')) {
                code = code.replace('draw=_=>{', 'draw=_=>{\n  t||createCanvas(w=800,h=600)');
              }
              
              // Show cleaned code before validation
              console.log('Cleaned Code:', code);
              addChatMessage('system', `🧹 Cleaned Code:`, code);
              
              // Validate code syntax before using
              try {
                new Function(code);
                console.log('✅ Code syntax validation passed');
              } catch (syntaxError) {
                console.error('❌ Syntax Error Details:', syntaxError);
                console.error('❌ Problematic Code:', code);
                console.warn('Generated code has syntax errors, using template instead');
                
                // Show detailed error info in chat
                addChatMessage('system', `❌ Syntax Error: ${syntaxError.message}`);
                addChatMessage('system', `🐛 Problematic Code: "${code.substring(0, 100)}${code.length > 100 ? '...' : ''}"`);
                addChatMessage('system', `❌ Qwen2.5 model generated invalid syntax. Code generation failed.`);
                
                console.log('%c🤖 Qwen Syntax Error', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', syntaxError);
                updateStatus('❌ Qwen generated invalid syntax - code generation failed');
                return; // Exit without generating code
              }
              aiResponse = `I've created a custom p5.js animation for "${userPrompt}" using Qwen2.5-0.5B (attempt ${generationAttempts}) with optimized inference parameters.`;
              updateStatus(`🚀 Qwen2.5-0.5B generated code (attempt ${generationAttempts})!`);
              qwenSuccess = true;
              
            } catch (qwenError) {
              console.error(`Qwen generation attempt ${generationAttempts} failed:`, qwenError);
              
              // If this is the last attempt, provide detailed error feedback
              if (generationAttempts >= maxGenerationAttempts) {
                // Provide specific feedback for different error types
                let errorMessage = qwenError.message;
                if (errorMessage.includes('WebGPU') && errorMessage.includes('Unsupported data type')) {
                  errorMessage = 'WebGPU compatibility issue with model data types';
                } else if (errorMessage.includes('ReduceMean')) {
                  errorMessage = 'ONNX runtime execution error';
                } else if (errorMessage.includes('out of memory')) {
                  errorMessage = 'Insufficient memory for model execution';
                } else if (errorMessage.includes('pipeline')) {
                  errorMessage = 'Pipeline execution error';
                }
                
                addChatMessage('ai', `❌ Qwen2.5 failed after ${generationAttempts} attempts: ${errorMessage}. Code generation failed.`);
                console.log('%c🤖 Qwen Final Failure', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', errorMessage);
                updateStatus('❌ Qwen failed all attempts - code generation failed');
                return; // Exit without generating code
              } else {
                // Try again with different parameters
                addChatMessage('system', `⚠️ Qwen2.5 attempt ${generationAttempts} failed, trying again with different parameters...`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
              }
            }
          }
        } else if (aiSession.type === 'openai') {
          // Standard OpenAI generation (fallback when agent system not available)
          const result = await handleStandardOpenAIGeneration(userPrompt);
          code = result.code;
          aiResponse = result.aiResponse;
        } else if (aiSession.type === 'lmstudio') {
          // LM Studio generation
          const result = await handleLMStudioGeneration(userPrompt);
          code = result.code;
          aiResponse = result.aiResponse;
        } else if (aiSession.type === 'ollama') {
          // Ollama generation
          const result = await handleOllamaGeneration(userPrompt);
          code = result.code;
          aiResponse = result.aiResponse;
        } else {
          // aiSession is not valid
          code = '';
          aiResponse = 'AI is not properly initialized. Please connect an AI model.';
          updateStatus('❌ AI not available');
        }
        
        if (code.length > 10) {
          editorInstance.setValue(code);
          
          // Execute the code safely
          try {
            window.runSketch(code);
            updateStatus('✅ Code generated and executed successfully!');
          } catch (runError) {
            console.error('Error running generated code:', runError);
            updateStatus('⚠️ Code generated but execution failed. Check the code editor.');
            addChatMessage('ai', `⚠️ Generated code but execution failed: ${runError.message}. You can still edit and run it manually.`);
          }
          
          // Add AI response to chat with code preview
          const codePreview = code.split('\n').slice(0, 3).join('\n') + (code.split('\n').length > 3 ? '\n...' : '');
          addChatMessage('ai', aiResponse, codePreview);
          
        } else {
          addChatMessage('ai', 'Sorry, I couldn\'t generate valid code for that prompt. Could you try describing it differently?');
          updateStatus('❌ Generated invalid code. Try a different prompt.');
        }
    }

    // Standard OpenAI Generation (fallback function)
    async function handleStandardOpenAIGeneration(userPrompt) {
      let code = '';
      let aiResponse = '';
      
      try {
        // OpenAI API call for creative coding with JSON response format
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${aiSession.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: aiSession.model,
            messages: [
              { role: 'system', content: customContexts.creative.systemPrompt },
              { role: 'user', content: customContexts.creative.userTemplate.replace('{prompt}', userPrompt) }
            ],
            max_tokens: 1200,
            temperature: 0.7,
            response_format: { type: "json_object" }
          })
        });
        
        if (!response.ok) {
          throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const rawContent = data.choices[0].message.content.trim();
        
        // Console log raw OpenAI API response
        console.log('%c🚀 RAW OPENAI API RESPONSE (Standard)', 'background: #00a67d; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
        console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
        console.log('%cRaw Content:', 'color: #666; font-weight: bold;', rawContent);
        
        // Parse JSON response
        let jsonResponse;
        try {
          jsonResponse = JSON.parse(rawContent);
          console.log('%cParsed JSON:', 'color: #666; font-weight: bold;', jsonResponse);
        } catch (jsonError) {
          console.warn('Failed to parse JSON, falling back to text extraction:', jsonError);
          // Fallback: try to extract code from raw text
          code = rawContent.replace(/```javascript\n?/g, '').replace(/```\n?/g, '');
          code = code.replace(/```js\n?/g, '').replace(/```\n?/g, '');
          
          const codeMatch = code.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
          if (codeMatch) {
            code = codeMatch[1];
          }
          
          aiResponse = `I've created a p5.js animation for "${userPrompt}" using ${aiSession.model} (text fallback).`;
          updateStatus(`🚀 ${aiSession.model} generated code (text fallback)!`);
          console.log('%cUsing text fallback code:', 'color: #666; font-weight: bold;', code);
          return { code, aiResponse };
        }
        
        // Extract code and description from JSON
        if (jsonResponse && jsonResponse.code) {
          code = jsonResponse.code;
          
          // Handle escaped newlines in JSON
          code = code.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
          
          // Validate and clean the code
          if (!code.includes('t=0')) {
            code = 't=0\n' + code;
          }
          if (!code.includes('createCanvas')) {
            code = code.replace('draw=_=>{', 'draw=_=>{\n  t||createCanvas(w=800,h=600)');
          }
          
          const description = jsonResponse.description || `Animation for "${userPrompt}"`;
          aiResponse = `🎨 ${description} Generated using ${aiSession.model} with structured JSON response!`;
          
          console.log('%cExtracted Code from JSON:', 'color: #666; font-weight: bold;', code);
          console.log('%cDescription:', 'color: #666; font-weight: bold;', description);
          
        } else {
          throw new Error('JSON response missing required "code" field');
        }
        
        updateStatus(`🚀 ${aiSession.model} generated structured code!`);
        
      } catch (error) {
        console.error('OpenAI API error:', error);
        code = '';
        aiResponse = `OpenAI API error: ${error.message}. Please check your API key and try again.`;
        updateStatus('❌ OpenAI API error');
      }
      
      return { code, aiResponse };
    }

    // LM Studio Generation
    async function handleLMStudioGeneration(userPrompt) {
      let code = '';
      let aiResponse = '';
      
      try {
        // LM Studio API call for creative coding with JSON response format
        const response = await fetch(`${aiSession.baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors',
          body: JSON.stringify({
            model: aiSession.model,
            messages: [
              { role: 'system', content: customContexts.creative.systemPrompt },
              { role: 'user', content: customContexts.creative.userTemplate.replace('{prompt}', userPrompt) }
            ],
            max_tokens: 1200,
            temperature: 0.7
          })
        });
        
        if (!response.ok) {
          throw new Error(`LM Studio API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const rawContent = data.choices[0].message.content.trim();
        
        // Console log raw LM Studio API response
        console.log('%c🏠 RAW LM STUDIO RESPONSE (Creative)', 'background: #4facfe; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
        console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
        console.log('%cRaw Content:', 'color: #666; font-weight: bold;', rawContent);
        
        // Parse JSON response
        let jsonResponse;
        try {
          jsonResponse = JSON.parse(rawContent);
          console.log('%cParsed JSON:', 'color: #666; font-weight: bold;', jsonResponse);
          
          code = jsonResponse.code?.replace(/\\n/g, '\n').replace(/\\t/g, '\t') || '';
          aiResponse = jsonResponse.description || 'LM Studio generated creative code!';
          
        } catch (parseError) {
          console.log('%cJSON Parse Failed, trying fallback extraction:', 'color: #orange; font-weight: bold;', parseError);
          
          // Fallback: Try to extract code between backticks or other patterns
          const codeMatch = rawContent.match(/```(?:javascript|js)?\n?([\s\S]*?)\n?```/);
          if (codeMatch) {
            code = codeMatch[1].trim();
            aiResponse = 'Code extracted from LM Studio response';
          } else {
            // Last resort: treat entire response as code if it looks like code
            if (rawContent.includes('createCanvas') || rawContent.includes('draw=') || rawContent.includes('background(')) {
              code = rawContent;
              aiResponse = 'Raw code from LM Studio';
            } else {
              code = '';
              aiResponse = rawContent || 'LM Studio response could not be parsed';
            }
          }
        }
        
        updateStatus(`🏠 ${aiSession.model} generated code!`);
        
      } catch (error) {
        console.error('LM Studio API error:', error);
        code = '';
        aiResponse = `LM Studio API error: ${error.message}. Please check that LM Studio is running on port 1234.`;
        updateStatus('❌ LM Studio API error');
      }
      
      return { code, aiResponse };
    }

    // Ollama Generation
    async function handleOllamaGeneration(userPrompt) {
      let code = '';
      let aiResponse = '';
      
      try {
        // Build Qwen chat prompt using proper template
        const systemPrompt = customContexts.creative.systemPrompt;
        const userMessage = customContexts.creative.userTemplate.replace('{prompt}', userPrompt);
        const chatPrompt = customContexts.qwen.creative.buildPrompt(systemPrompt, userMessage);
        
        // Console log the formatted prompt
        console.log('%c🦙 OLLAMA QUERY (Creative)', 'background: #00d4aa; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
        console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', chatPrompt);
        
        // Ollama API call for creative coding
        const response = await fetch(`${aiSession.baseURL}/api/generate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors',
          body: JSON.stringify({
            model: aiSession.model,
            prompt: chatPrompt,
            stream: false,
            options: {
              temperature: 0.7,
              top_p: 0.9,
              max_tokens: 1200,
              stop: ['<|im_end|>']
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`Ollama API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const rawContent = data.response || '';
        
        // Parse response using Qwen template
        let parsedContent = customContexts.qwen.creative.parseResponse(rawContent, '');
        
        // Console log raw Ollama API response
        console.log('%c🦙 RAW OLLAMA RESPONSE (Creative)', 'background: #00d4aa; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
        console.log('%cFull API Response:', 'color: #666; font-weight: bold;', data);
        console.log('%cParsed Content:', 'color: #666; font-weight: bold;', parsedContent);
        
        // Try to parse as JSON first
        let jsonResponse;
        try {
          jsonResponse = JSON.parse(parsedContent);
          console.log('%cParsed JSON:', 'color: #666; font-weight: bold;', jsonResponse);
          
          code = jsonResponse.code?.replace(/\\n/g, '\n').replace(/\\t/g, '\t') || '';
          aiResponse = jsonResponse.description || 'Ollama generated creative code!';
          
        } catch (parseError) {
          console.log('%cJSON Parse Failed, trying fallback extraction:', 'color: #orange; font-weight: bold;', parseError);
          
          // Fallback: Try to extract code between backticks or other patterns
          const codeMatch = parsedContent.match(/```(?:javascript|js)?\n?([\s\S]*?)\n?```/);
          if (codeMatch) {
            code = codeMatch[1].trim();
            aiResponse = 'Code extracted from Ollama response';
          } else if (parsedContent.includes('createCanvas') || parsedContent.includes('draw=') || parsedContent.includes('background(')) {
            // Try to extract p5.js code patterns directly
            const p5Match = parsedContent.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
            if (p5Match) {
              code = p5Match[1].trim();
              aiResponse = 'P5.js pattern extracted from Ollama response';
            } else {
              code = parsedContent;
              aiResponse = 'Raw code from Ollama';
            }
          } else {
            code = '';
            aiResponse = parsedContent || 'Ollama response could not be parsed as code';
          }
        }
        
        updateStatus(`🦙 ${aiSession.model} generated code!`);
        
      } catch (error) {
        console.error('Ollama API error:', error);
        code = '';
        aiResponse = `Ollama API error: ${error.message}. Please check that Ollama is running on port 11434.`;
        updateStatus('❌ Ollama API error');
      }
      
      return { code, aiResponse };
    }

    function updateStatus(message) {
      document.getElementById('statusBar').textContent = message;
      setTimeout(() => {
        document.getElementById('statusBar').textContent = 'Ready to create amazing p5.js art! 🚀';
      }, 3000);
    }

    // Chat Functions
    function addChatMessage(type, content, codePreview = null) {
      const chatHistoryEl = document.getElementById('chatHistory');
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${type}`;
      
      let headerText = '';
      switch(type) {
        case 'user': headerText = '👤 You'; break;
        case 'ai': 
          if (aiSession && aiSession.type === 'qwen') {
            headerText = '🧠 Qwen2.5-0.5B';
          } else if (aiSession && aiSession.type === 'openai') {
            headerText = '🤖 AI Assistant';
          } else if (aiSession && aiSession.type === 'lmstudio') {
            headerText = '🏠 LM Studio';
          } else {
            headerText = '🤖 AI Assistant';
          }
          break;
        case 'system': headerText = '⚙️ System'; break;
      }
      
      messageEl.innerHTML = `
        <div class="message-header">${headerText}</div>
        <div>${content}</div>
        ${codePreview ? `<div class="code-preview">${codePreview}</div>` : ''}
      `;
      
      chatHistoryEl.appendChild(messageEl);
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      
      // Store in history
      chatHistory.push({ type, content, codePreview, timestamp: Date.now() });
    }

    // AI Panel Functions
    function toggleAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleBtn.classList.add('active');
      } else {
        panel.classList.add('hidden');
        toggleBtn.classList.remove('active');
      }
    }

    function minimizeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const content = document.getElementById('aiContent');
      const minimizeBtn = document.getElementById('minimizeBtn');
      
      if (panel.classList.contains('minimized')) {
        // Restore panel
        panel.classList.remove('minimized');
        content.classList.remove('minimized');
        minimizeBtn.textContent = '−';
        minimizeBtn.title = 'Minimize Panel';
        updateStatus('🤖 AI panel restored');
      } else {
        // Minimize panel - keep header visible
        panel.classList.add('minimized');
        content.classList.add('minimized');
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Restore Panel';
        updateStatus('📦 AI panel minimized');
      }
    }

    function closeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      panel.classList.add('hidden');
      toggleBtn.classList.remove('active');
    }

    // Toggle between Creative and General chat modes
    function toggleChatMode() {
      const modeBtn = document.getElementById('chatModeBtn');
      const promptInput = document.getElementById('aiPrompt');
      
      if (chatMode === 'creative') {
        chatMode = 'general';
        modeBtn.textContent = '💬 General Chat';
        modeBtn.style.background = 'linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)';
        promptInput.placeholder = 'Ask me anything... e.g., "Explain how neural networks work" or "What is the weather like?"';
        addChatMessage('system', '💬 Switched to General Chat mode. You can now ask any questions without p5.js code generation.');
      } else {
        chatMode = 'creative';
        modeBtn.textContent = '🎨 Creative Mode';
        modeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        promptInput.placeholder = 'Describe what you want to create... e.g., "colorful spinning triangles" or "particle system with gravity"';
        addChatMessage('system', '🎨 Switched to Creative Coding mode. Describe visual patterns to generate p5.js code.');
      }
    }

    // Show Context Editor Modal
    function showContextEditor() {
      const modal = document.createElement('div');
      modal.className = 'context-editor-modal';
      modal.id = 'contextEditorModal';
      
      modal.innerHTML = `
        <div class="context-editor-content">
          <div class="context-editor-header">
            <h2>⚙️ Context Editor</h2>
            <button class="context-btn secondary" onclick="closeContextEditor()">×</button>
          </div>
          
          <div class="model-selector">
            <label style="color: rgba(255,255,255,0.8); font-weight: 600;">Model:</label>
            <select id="modelSelect">
              <option value="qwen">Qwen2.5-0.5B</option>
            </select>
          </div>
          
          <div class="context-sections">
            <div class="context-section">
              <h3>💬 General Chat Context</h3>
              
              <div class="context-input-group">
                <label>System Prompt:</label>
                <textarea id="generalSystemPrompt" class="context-textarea" placeholder="Define the AI's role and behavior for general conversations...">${customContexts.general.systemPrompt}</textarea>
                <div class="context-template-hint">Sets the AI's personality and behavior for general questions</div>
              </div>
              
              <div class="context-input-group">
                <label>User Message Template:</label>
                <textarea id="generalUserTemplate" class="context-textarea large" placeholder="Template for user messages... Use {prompt} as placeholder">${customContexts.general.userTemplate}</textarea>
                <div class="context-template-hint">Use {prompt} where user input should be inserted</div>
              </div>
            </div>
            
            <div class="context-section">
              <h3>🎨 Creative Chat Context</h3>
              
              <div class="context-input-group">
                <label>System Prompt:</label>
                <textarea id="creativeSystemPrompt" class="context-textarea" placeholder="Define the AI's role for code generation...">${customContexts.creative.systemPrompt}</textarea>
                <div class="context-template-hint">Sets the AI's behavior for p5.js code generation</div>
              </div>
              
              <div class="context-input-group">
                <label>User Message Template:</label>
                <textarea id="creativeUserTemplate" class="context-textarea large" placeholder="Template for creative prompts... Use {prompt} as placeholder">${customContexts.creative.userTemplate}</textarea>
                <div class="context-template-hint">Include instructions and examples for p5.js code generation</div>
              </div>
            </div>
          </div>
          
          <div class="context-editor-actions">
            <div>
              <button class="context-btn secondary" onclick="resetContexts()">🔄 Reset to Defaults</button>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="context-btn secondary" onclick="closeContextEditor()">Cancel</button>
              <button class="context-btn primary" onclick="saveContexts()">💾 Save & Apply</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Close Context Editor
    function closeContextEditor() {
      const modal = document.getElementById('contextEditorModal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        }, 200);
      }
    }

    // Save custom contexts
    function saveContexts() {
      const generalSystem = document.getElementById('generalSystemPrompt').value.trim();
      const generalUser = document.getElementById('generalUserTemplate').value.trim();
      const creativeSystem = document.getElementById('creativeSystemPrompt').value.trim();
      const creativeUser = document.getElementById('creativeUserTemplate').value.trim();
      
      // Validate inputs
      if (!generalSystem || !generalUser || !creativeSystem || !creativeUser) {
        alert('All fields are required. Please fill in all context templates.');
        return;
      }
      
      if (!generalUser.includes('{prompt}') || !creativeUser.includes('{prompt}')) {
        alert('User templates must contain {prompt} placeholder for user input.');
        return;
      }
      
      // Save to custom contexts
      customContexts.general.systemPrompt = generalSystem;
      customContexts.general.userTemplate = generalUser;
      customContexts.creative.systemPrompt = creativeSystem;
      customContexts.creative.userTemplate = creativeUser;
      
      closeContextEditor();
      addChatMessage('system', '✅ Custom contexts saved and applied! Your chat templates are now active for this session.');
      updateStatus('✅ Custom contexts applied successfully!');
      
      // Track context customization
      if (window.AppConfig) {
        window.AppConfig.trackEvent('context_customized', 'ai_interaction', 'custom_templates');
      }
    }

    // Reset contexts to defaults
    function resetContexts() {
      if (confirm('Reset all contexts to default values? This will overwrite your current changes.')) {
        // Reset to original defaults
        document.getElementById('generalSystemPrompt').value = 'You are a helpful AI assistant. Answer questions clearly and informatively.';
        document.getElementById('generalUserTemplate').value = 'Question: {prompt}\n\nAnswer this question clearly and informatively (maximum 10 lines). Be direct and helpful.';
        document.getElementById('creativeSystemPrompt').value = 'You are a p5.js creative coding assistant. Generate compact, creative p5.js code that creates visual art and animations. Always respond in JSON format.';
        document.getElementById('creativeUserTemplate').value = `Create p5.js code for: {prompt}

REQUIREMENTS:
1. Use compact syntax with t=0 and draw=_=>{...} pattern
2. Always include t||createCanvas(w=800,h=600) for setup
3. Use t+=0.01 to 0.1 for animation timing
4. Create visually interesting patterns using sin(), cos(), loops
5. Use fill() and stroke() for colors
6. Available functions: ellipse(), rect(), line(), point(), triangle(), arc()
7. Use mathematical patterns: sin(t+i), cos(t*2+i*0.1), etc.

EXAMPLES:
- Spiral: for(i=0;i<100;i++){x=400+cos(t+i*0.1)*i*2; y=300+sin(t+i*0.1)*i*2; ellipse(x,y,5)}
- Particles: for(i=0;i<50;i++){ellipse(400+sin(t+i)*100, 300+cos(t+i*0.5)*100, 8)}
- Waves: for(i=0;i<800;i+=10){ellipse(i, 300+sin(i*0.02+t)*50, 6)}

Return response as JSON:
{
  "code": "t=0\\ndraw=_=>{\\n  t||createCanvas(w=800,h=600)\\n  background(0,20)\\n  t+=0.05\\n  // your creative code here\\n}",
  "description": "Brief description of the animation"
}`;
      }
    }

    // Editor expand/minimize functions
    function expandEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const canvasContainer = document.querySelector('.canvas-container');
      const expandBtn = document.getElementById('expandEditorBtn');
      
      if (editorContainer.classList.contains('expanded')) {
        // Restore normal view
        editorContainer.classList.remove('expanded');
        canvasContainer.classList.remove('hidden');
        expandBtn.textContent = '⤢';
        expandBtn.title = 'Expand Editor';
        updateStatus('📝 Editor restored to normal view');
      } else {
        // Expand editor
        editorContainer.classList.add('expanded');
        canvasContainer.classList.add('hidden');
        expandBtn.textContent = '⤡';
        expandBtn.title = 'Restore Editor';
        updateStatus('📝 Editor expanded for full-screen coding');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    function minimizeEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const minimizeBtn = document.getElementById('minimizeEditorBtn');
      
      if (editorContainer.classList.contains('minimized')) {
        // Restore editor
        editorContainer.classList.remove('minimized');
        minimizeBtn.textContent = '−';
        minimizeBtn.title = 'Minimize Editor';
        updateStatus('📝 Editor restored');
      } else {
        // Minimize editor
        editorContainer.classList.add('minimized');
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Restore Editor';
        updateStatus('📝 Editor minimized');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    // Resizable Editor/Canvas Functionality
    function initializeResizeHandle() {
      const resizeHandle = document.getElementById('resizeHandle');
      const container = document.querySelector('.container');
      
      let isResizing = false;
      let currentEditorFr = 1.2; // Track current fr values
      let currentCanvasFr = 2.4;
      
      // Double-click to reset to default sizes
      resizeHandle.addEventListener('dblclick', (e) => {
        e.preventDefault();
        currentEditorFr = 1.2;
        currentCanvasFr = 2.4;
        container.style.gridTemplateColumns = '250px 1.2fr 6px 2.4fr';
        updateStatus('🔄 Layout reset to default (1:2 ratio)');
        
        // Visual feedback
        resizeHandle.style.background = 'rgba(76, 175, 80, 0.8)';
        setTimeout(() => {
          resizeHandle.style.background = '';
          if (editorInstance) editorInstance.layout();
        }, 300);
      });
      
      let startX = 0;
      let startEditorFr = 0;
      let startCanvasFr = 0;
      
      resizeHandle.addEventListener('mousedown', (e) => {
        if (e.detail === 2) return; // Skip if double-click
        
        isResizing = true;
        startX = e.clientX;
        
        // Use current fr values as starting point
        startEditorFr = currentEditorFr;
        startCanvasFr = currentCanvasFr;
        
        console.log(`Starting resize - Editor: ${startEditorFr}fr, Canvas: ${startCanvasFr}fr`);
        
        resizeHandle.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
        
        updateStatus('🔧 Resizing... (Double-click to reset)');
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        
        // Increased sensitivity for more noticeable movement
        const sensitivity = 0.008; // More responsive
        const frChange = deltaX * sensitivity;
        
        // Calculate new fr values from the ACTUAL starting values
        let newEditorFr = startEditorFr + frChange;
        let newCanvasFr = startCanvasFr - frChange;
        
        // Maintain proper inverse relationship with constraints
        const minFr = 0.4;
        const maxFr = 3.5;
        
        // If one panel hits its limit, stop both from changing further
        if (newEditorFr < minFr) {
          newEditorFr = minFr;
          newCanvasFr = startEditorFr + startCanvasFr - minFr; // Maintain total
        } else if (newEditorFr > maxFr) {
          newEditorFr = maxFr;
          newCanvasFr = startEditorFr + startCanvasFr - maxFr;
        }
        
        if (newCanvasFr < minFr) {
          newCanvasFr = minFr;
          newEditorFr = startEditorFr + startCanvasFr - minFr;
        } else if (newCanvasFr > maxFr) {
          newCanvasFr = maxFr;
          newEditorFr = startEditorFr + startCanvasFr - maxFr;
        }
        
        // Update current values
        currentEditorFr = newEditorFr;
        currentCanvasFr = newCanvasFr;
        
        console.log(`Delta: ${deltaX}, FrChange: ${frChange.toFixed(3)}, Editor: ${newEditorFr.toFixed(2)}fr, Canvas: ${newCanvasFr.toFixed(2)}fr, Total: ${(newEditorFr + newCanvasFr).toFixed(2)}fr`);
        
        // Apply directly to grid
        container.style.gridTemplateColumns = `250px ${newEditorFr}fr 6px ${newCanvasFr}fr`;
        
        // Trigger editor resize
        if (editorInstance) {
          editorInstance.layout();
        }
      });
      
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          
          resizeHandle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
          
          const ratio = (currentEditorFr / currentCanvasFr).toFixed(1);
          updateStatus(`✅ Resized - Editor:Canvas ratio is ${ratio}:1`);
          
          console.log(`Final state - Editor: ${currentEditorFr.toFixed(2)}fr, Canvas: ${currentCanvasFr.toFixed(2)}fr`);
          
          // Final editor layout
          setTimeout(() => {
            if (editorInstance) editorInstance.layout();
          }, 100);
        }
      });
      
      // Window resize handler
      window.addEventListener('resize', () => {
        if (editorInstance) {
          setTimeout(() => editorInstance.layout(), 100);
        }
      });
      
      // Initialize with proper default values
      container.style.gridTemplateColumns = '250px 1.2fr 6px 2.4fr';
    }

    // Runner: execute user code in p5 context (Global scope)
    window.runSketch = function(src) {
      if (currentP5) currentP5.remove();

      try {
        updateStatus('🎨 Running your code...');
        
        // Create p5 instance and execute the user's code
        currentP5 = new p5((p) => {
          let originalDraw = null;
          
          // Make p5 functions available in global scope for user code
          const p5Functions = ['createCanvas', 'background', 'stroke', 'point', 'sin', 'cos', 'mag', 'noise', 'noFill', 'arc', 'fill', 'noStroke', 'strokeWeight', 'ellipse', 'rect', 'line', 'triangle', 'quad', 'bezier', 'curve', 'random'];
          
          p5Functions.forEach(fn => {
            if (p[fn]) {
              window[fn] = p[fn].bind(p);
            }
          });
          
          // Constants
          window.PI = p.PI;
          window.TWO_PI = p.TWO_PI;
          window.HALF_PI = p.HALF_PI;
          window.PIE = p.PIE;
          window.CHORD = p.CHORD;
          window.OPEN = p.OPEN;
          
          // Common variables
          window.w = 400;
          window.W = 720;
          
          try {
            // Execute user code directly
            eval(src);
            
            // If draw function was created globally, use it
            if (window.draw && typeof window.draw === 'function') {
              originalDraw = window.draw;
              
              // Store original frameRate
              const originalFrameRate = p.frameRate;
              
              // Wrap the draw function with pause/play and speed control
              p.draw = function() {
                if (animationPaused) {
                  return; // Skip drawing when paused
                }
                
                // Apply speed control by adjusting frameRate
                const targetFrameRate = 60 * speedMultiplier;
                p.frameRate(targetFrameRate);
                
                originalDraw();
              };
              
              updateStatus('✅ Code executed successfully!');
            }
            
          } catch (evalError) {
            console.error('Error executing user code:', evalError);
            updateStatus('❌ Code error: ' + evalError.message);
            // Fallback to a simple sketch
            p.setup = function() {
              p.createCanvas(400, 400);
              p.background(50);
            };
            p.draw = function() {
              p.stroke(255);
              p.text('Code Error: Check Console', 10, 20);
            };
          }
          
        }, 'canvas');
        
      } catch (error) {
        console.error('Error running sketch:', error);
        updateStatus('❌ Failed to run sketch');
      }
    };

    require(['vs/editor/editor.main'], async () => {
      // Initialize Monaco with bird.js as default
      let defaultCode = [
        '// Welcome to SketchPad-SLM!',
        '// Loading default bird animation...',
        '',
        't=0',
        'draw=_=>{',
        '  t||createCanvas(400,400)',
        '  background(0)',
        '  t+=0.05',
        '  ',
        '  fill(255)',
        '  text("Loading bird animation...", 20, 200)',
        '}'
      ].join('\n');
      
      // Try to load bird.js as default
      try {
        const response = await fetch('lib/Designs/bird.js');
        if (response.ok) {
          defaultCode = await response.text();
          updateStatus('🦅 Loaded bird.js as default animation');
        } else {
          updateStatus('⚠️ Using fallback code - bird.js not found');
        }
      } catch (error) {
        console.warn('Could not load bird.js as default:', error);
        updateStatus('⚠️ Using fallback code - bird.js load failed');
      }
      
      editorInstance = monaco.editor.create(
        document.getElementById('editor'), {
          value: defaultCode,
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 14,
          fontFamily: 'Consolas, "Courier New", monospace',
          fontWeight: '400',
          lineHeight: 21,
          letterSpacing: 0.5,
          
          // Line numbers and gutter
          lineNumbers: 'on',
          lineNumbersMinChars: 3,
          glyphMargin: true,
          folding: true,
          foldingStrategy: 'indentation',
          
          // Scrolling and viewport
          scrollBeyondLastLine: false,
          smoothScrolling: true,
          mouseWheelZoom: true,
          
          // Word wrapping
          wordWrap: 'on',
          wordWrapColumn: 80,
          wrappingIndent: 'indent',
          
          // Minimap
          minimap: { 
            enabled: true,
            side: 'right',
            showSlider: 'always',
            scale: 1
          },
          
          // Suggestions and IntelliSense
          suggestOnTriggerCharacters: true,
          acceptSuggestionOnCommitCharacter: true,
          acceptSuggestionOnEnter: 'on',
          tabCompletion: 'on',
          wordBasedSuggestions: true,
          quickSuggestions: {
            other: true,
            comments: true,
            strings: true
          },
          parameterHints: {
            enabled: true,
            cycle: true
          },
          
          // Editor behavior
          autoIndent: 'full',
          formatOnPaste: true,
          formatOnType: true,
          insertSpaces: true,
          tabSize: 2,
          detectIndentation: true,
          trimAutoWhitespace: true,
          
          // Selection and cursors
          selectOnLineNumbers: true,
          multiCursorModifier: 'ctrlCmd',
          cursorBlinking: 'smooth',
          cursorSmoothCaretAnimation: true,
          cursorWidth: 2,
          
          // Bracket matching
          matchBrackets: 'always',
          autoClosingBrackets: 'always',
          autoClosingQuotes: 'always',
          autoSurround: 'languageDefined',
          
          // Find and replace
          find: {
            autoFindInSelection: 'never',
            seedSearchStringFromSelection: 'always'
          },
          
          // Advanced features
          codeLens: false,
          contextmenu: true,
          links: true,
          colorDecorators: true,
          lightbulb: {
            enabled: true
          },
          
          // Performance
          renderWhitespace: 'selection',
          renderControlCharacters: false,
          renderLineHighlight: 'line',
          highlightActiveIndentGuide: true,
          
          // Scrollbar
          scrollbar: {
            useShadows: true,
            verticalHasArrows: false,
            horizontalHasArrows: false,
            vertical: 'visible',
            horizontal: 'visible',
            verticalScrollbarSize: 14,
            horizontalScrollbarSize: 14
          }
      });

      // Load design from lib/Designs folder
      async function loadDesign(designName) {
        if (!designName) return;
        
        try {
          updateStatus(`📁 Loading ${designName}...`);
          const response = await fetch(designs[designName]);
          if (response.ok) {
            const code = await response.text();
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`✅ Loaded ${designName} successfully!`);
          } else {
            updateStatus(`❌ Failed to load ${designName}`);
          }
        } catch (error) {
          console.error('Error loading design:', error);
          updateStatus(`❌ Error loading ${designName}`);
        }
      }

      // Event Listeners
      document.getElementById('runBtn').addEventListener('click', () => {
        // Track code execution
        if (window.AppConfig) {
          window.AppConfig.trackEvent('code_executed', 'user_interaction', 'run_button');
        }
        window.runSketch(editorInstance.getValue());
      });

      document.getElementById('designSelect').addEventListener('change', (e) => {
        // Track design selection
        if (window.AppConfig && e.target.value) {
          window.AppConfig.trackEvent('design_loaded', 'user_interaction', e.target.value);
        }
        loadDesign(e.target.value);
      });

      document.getElementById('loadFileBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.name.endsWith('.js')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const code = e.target.result;
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`✅ Loaded ${file.name}`);
          };
          reader.readAsText(file);
        } else {
          updateStatus('❌ Please select a .js file');
        }
      });

      document.getElementById('saveFileBtn').addEventListener('click', () => {
        const code = editorInstance.getValue();
        const blob = new Blob([code], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sketch_${Date.now()}.js`;
        a.click();
        URL.revokeObjectURL(url);
        updateStatus('💾 File saved successfully!');
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (currentP5) {
          currentP5.remove();
          currentP5 = null;
          updateStatus('🗑️ Canvas cleared');
        }
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        editorInstance.setValue([
          '// Welcome to SketchPad-SLM!',
          '// Edit this code and click "Draw" to see magic happen ✨',
          '',
          't=0',
          'draw=_=>{',
          '  t||createCanvas(400,400)',
          '  background(0)',
          '  t+=0.05',
          '  ',
          '  // Your creative code here!',
          '  fill(sin(t)*127+128,cos(t)*127+128,255)',
          '  ellipse(200+sin(t)*100,200+cos(t)*100,50,50)',
          '}'
        ].join('\n'));
        updateStatus('🔄 Code reset to template');
      });

      // AI Event Listeners
      document.getElementById('initAIBtn').addEventListener('click', () => {
        // Track AI initialization
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_init_clicked', 'ai_interaction', 'init_button');
        }
        initializeAI();
      });
      
      document.getElementById('chatModeBtn').addEventListener('click', () => {
        // Track chat mode toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('chat_mode_toggled', 'ai_interaction', chatMode);
        }
        toggleChatMode();
      });
      
      document.getElementById('contextBtn').addEventListener('click', () => {
        // Track context editor open
        if (window.AppConfig) {
          window.AppConfig.trackEvent('context_editor_opened', 'ai_interaction', 'context_button');
        }
        showContextEditor();
      });
      
      document.getElementById('generateBtn').addEventListener('click', () => {
        // Check if user has accepted agreement first
        if (!userAgreementAccepted) {
          showUserAgreement();
          return;
        }
        
        const prompt = document.getElementById('aiPrompt').value.trim();
        if (prompt) {
          // Track AI code generation
          if (window.AppConfig) {
            window.AppConfig.trackEvent('ai_code_generated', 'ai_interaction', chatMode, prompt.length);
          }
          generateAICode(prompt);
        } else {
          updateStatus('❌ Please enter a prompt first');
        }
      });

      // Allow Enter key in prompt textarea to generate
      document.getElementById('aiPrompt').addEventListener('keydown', (e) => {
        // Enter (without Shift) generates code
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault(); // Prevent new line
          const prompt = e.target.value.trim();
          if (prompt && !document.getElementById('generateBtn').disabled) {
            generateAICode(prompt);
            // Clear the input after generating
            setTimeout(() => {
              e.target.value = '';
            }, 100);
          }
        }
        // Shift+Enter allows new lines for multi-line prompts
      });

      // AI Panel event listeners
      document.getElementById('aiToggleBtn').addEventListener('click', () => {
        // Track AI panel toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_toggled', 'ui_interaction', 'toggle_button');
        }
        toggleAIPanel();
      });
      
      document.getElementById('minimizeBtn').addEventListener('click', () => {
        // Track AI panel minimize
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_minimized', 'ui_interaction', 'minimize_button');
        }
        minimizeAIPanel();
      });
      
      document.getElementById('closeBtn').addEventListener('click', () => {
        // Track AI panel close
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_closed', 'ui_interaction', 'close_button');
        }
        closeAIPanel();
      });
      
      // Click on header to restore minimized panel
      document.querySelector('.ai-panel-header').addEventListener('click', (e) => {
        const panel = document.getElementById('aiFloatingPanel');
        
        // Only restore if panel is minimized and we're not clicking on control buttons
        if (panel.classList.contains('minimized') && 
            !e.target.closest('.ai-panel-controls')) {
          // Track header click restore
          if (window.AppConfig) {
            window.AppConfig.trackEvent('ai_panel_restored', 'ui_interaction', 'header_click');
          }
          minimizeAIPanel(); // This will toggle from minimized to restored
        }
      });

      // Editor control event listeners
      document.getElementById('expandEditorBtn').addEventListener('click', expandEditor);
      document.getElementById('minimizeEditorBtn').addEventListener('click', minimizeEditor);
      
      // Copy code button
      document.getElementById('copyCodeBtn').addEventListener('click', () => {
        const copyBtn = document.getElementById('copyCodeBtn');
        const originalText = copyBtn.textContent;
        const originalTitle = copyBtn.title;
        
        const code = editorInstance.getValue();
        navigator.clipboard.writeText(code).then(() => {
          // Show success feedback
          copyBtn.textContent = '✅';
          copyBtn.title = 'Code Copied!';
          copyBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
          copyBtn.style.transform = 'scale(1.1)';
          updateStatus('📄 Code copied to clipboard successfully!');
          
          // Restore original button after 2 seconds
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.title = originalTitle;
            copyBtn.style.background = '';
            copyBtn.style.transform = '';
          }, 2000);
          
        }).catch(err => {
          console.error('Failed to copy code:', err);
          // Show error feedback
          copyBtn.textContent = '❌';
          copyBtn.title = 'Copy Failed!';
          copyBtn.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
          updateStatus('❌ Failed to copy code to clipboard');
          
          // Restore original button after 2 seconds
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.title = originalTitle;
            copyBtn.style.background = '';
          }, 2000);
        });
      });
      
      // API mode toggle
      // Dev mode toggle
      document.getElementById('devModeBtn').addEventListener('click', () => {
        if (!devLogger) {
          devLogger = new DevLogger();
        }
        
        const loggerToggle = document.getElementById('devLoggerToggle');
        
        if (devModeActive) {
          devModeActive = false;
          window.devModeActive = false;
          devLogger.hide();
          document.getElementById('devModeBtn').textContent = '🔧 Dev Mode';
          document.getElementById('devModeBtn').style.background = 'rgba(255, 255, 255, 0.2)';
          loggerToggle.style.display = 'none';
          console.log('🔧 Dev Mode: DISABLED');
        } else {
          devModeActive = true;
          window.devModeActive = true;
          window.devLogger = devLogger;
          devLogger.show();
          document.getElementById('devModeBtn').textContent = '🔧 Dev Active';
          document.getElementById('devModeBtn').style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
          loggerToggle.style.display = 'inline-block';
          console.log('🔧 Dev Mode: ENABLED - Full agent pipeline logging active');
        }
        
        // Track dev mode toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('dev_mode_toggled', 'debug', devModeActive ? 'enabled' : 'disabled');
        }
      });
      
      // Dev logger toggle button
      document.getElementById('devLoggerToggle').addEventListener('click', () => {
        if (devLogger) {
          if (devLogger.isMinimized) {
            devLogger.minimize(); // This will expand it
          } else if (!devLogger.isVisible) {
            devLogger.show();
          } else {
            devLogger.minimize(); // This will minimize it
          }
        }
      });
      
      // AI provider selection
      document.getElementById('aiProviderSelect').addEventListener('change', (e) => {
        aiProvider = e.target.value;
        const apiKeySection = document.getElementById('apiKeySection');
        
        if (aiProvider === 'openai') {
          apiKeySection.style.display = 'block';
          document.getElementById('initAIBtn').textContent = '🚀 Connect OpenAI';
          updateStatus('🔑 OpenAI API mode enabled. Enter your API key.');
        } else if (aiProvider === 'lmstudio') {
          apiKeySection.style.display = 'none';
          document.getElementById('initAIBtn').textContent = '🏠 Connect LM Studio';
          updateStatus('🏠 LM Studio mode enabled. Make sure LM Studio is running on port 1234.');
        } else if (aiProvider === 'ollama') {
          apiKeySection.style.display = 'none';
          document.getElementById('initAIBtn').textContent = '🦙 Connect Ollama';
          updateStatus('🦙 Ollama mode enabled. Make sure Ollama is running on port 11434.');
        } else {
          apiKeySection.style.display = 'none';
          document.getElementById('initAIBtn').textContent = '🔌 Connect Qwen';
          updateStatus('🧠 Local mode enabled. Use Qwen2.5.');
        }
        
        // Reset AI session when switching providers
        aiSession = null;
        document.getElementById('aiStatus').textContent = 'AI: Not connected';
        document.getElementById('generateBtn').disabled = true;
        
        // Track provider change
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_provider_changed', 'ai_interaction', aiProvider);
        }
      });
      
      // API key visibility toggle
      document.getElementById('toggleApiKeyVisibility').addEventListener('click', () => {
        const apiKeyInput = document.getElementById('openaiApiKey');
        const toggleBtn = document.getElementById('toggleApiKeyVisibility');
        
        if (apiKeyInput.type === 'password') {
          apiKeyInput.type = 'text';
          toggleBtn.textContent = '🙈';
          toggleBtn.title = 'Hide API Key';
        } else {
          apiKeyInput.type = 'password';
          toggleBtn.textContent = '👁️';
          toggleBtn.title = 'Show API Key';
        }
      });
      
      // Agreement status button - now handled by the modular system
      
      // Disconnect AI button
      document.getElementById('disconnectAIBtn').addEventListener('click', () => {
        // Track AI disconnection
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_disconnected_manually', 'ai_interaction', 'disconnect_button');
        }
        disconnectAI();
      });
      
      // Canvas control buttons
      const pausePlayBtn = document.getElementById('pausePlayBtn');
      const speedBtn = document.getElementById('speedBtn');
      
      if (pausePlayBtn) {
        pausePlayBtn.addEventListener('click', () => {
          animationPaused = !animationPaused;
          
          if (animationPaused) {
            pausePlayBtn.textContent = '▶️';
            pausePlayBtn.title = 'Play Animation';
            pausePlayBtn.classList.add('active');
            updateStatus('⏸️ Animation paused');
          } else {
            pausePlayBtn.textContent = '⏸️';
            pausePlayBtn.title = 'Pause Animation';
            pausePlayBtn.classList.remove('active');
            updateStatus('▶️ Animation resumed');
          }
          
          // Track pause/play usage
          if (window.AppConfig) {
            window.AppConfig.trackEvent('animation_control', 'canvas_interaction', animationPaused ? 'paused' : 'resumed');
          }
        });
      }
      
      if (speedBtn) {
        speedBtn.addEventListener('click', () => {
          // Cycle through speed levels
          if (animationSpeed === 'slow') {
            animationSpeed = 'fast';
            speedMultiplier = 1.0;
            speedBtn.textContent = 'FAST';
            speedBtn.className = 'canvas-btn speed-btn fast';
          } else if (animationSpeed === 'fast') {
            animationSpeed = 'very-fast';
            speedMultiplier = 2.0;
            speedBtn.textContent = 'V-FAST';
            speedBtn.className = 'canvas-btn speed-btn very-fast';
          } else {
            animationSpeed = 'slow';
            speedMultiplier = 0.5;
            speedBtn.textContent = 'SLOW';
            speedBtn.className = 'canvas-btn speed-btn slow';
          }
          
          updateStatus(`🚀 Animation speed: ${animationSpeed.toUpperCase()}`);
          
          // Track speed changes
          if (window.AppConfig) {
            window.AppConfig.trackEvent('animation_speed_changed', 'canvas_interaction', animationSpeed);
          }
        });
      }

      // Auto-run bird animation on load
      setTimeout(() => {
        window.runSketch(editorInstance.getValue());
      }, 1000);

      // Initialize header AI status
      updateHeaderAIStatus();
      
      // Make dev logger globally available
      window.devModeActive = devModeActive;
      window.devLogger = devLogger;

      // Initialize resize handle functionality
      initializeResizeHandle();

      updateStatus('🚀 SketchPad-SLM loaded successfully!');
    });
  </script>
</body>
</html>
